<?php
	// error_reporting(0);
	
	define("ROOT", $_SERVER['DOCUMENT_ROOT'].'/');
	require_once(ROOT.'php/auth/auth.php');
	
	$logged = $auth->logged_in();
	if (!$logged) die();
	if (!isset($_FILES['uploadfile'])) die();
	
	$file_name = upload::upload_file($_FILES['uploadfile'], SCONFIG::UPLOAD_DIR);
	if (!$file_name) die();
	
	// RESIZING IMAGE
	
	if (! ImageHandler::resize(SCONFIG::UPLOAD_DIR.$file_name, 75, 75, false, true) )
	{
		print_r(error_get_last());
		upload::delete(SCONFIG::UPLOAD_DIR.$file_name);
		die();
	}
	
	//
	
	$db = SCONFIG::dbconnect();
	
	/*
	 *	CHECKS IF USER HAS ALREADY A PIC EITHER THAN DEFAULT
	 */
	 
	 $r = $db->query('SELECT `id`, `filename` FROM `users_pic` WHERE `user_id`='.$logged['id']);
	 $r_f = $db->fetch($r);
	 $current_pic = $db->numRows($r) == 1 ? $r_f : false;
	 if ($current_pic)
	 {
		 upload::delete(SCONFIG::UPLOAD_DIR.$current_pic['filename']);
		 $db->query('UPDATE `users_pic` SET `filename`=\''.$file_name.'\' WHERE `user_id`='.$logged['id']);
	 }
	 else	// IF USER HAS NO PICTURE
	 {
		 $db->query('INSERT INTO `users_pic` VALUES(NULL, '.$logged['id'].', \''.$file_name.'\')');
		 $pic_id = mysql_insert_id(); // GETTING NEW PICTURE ID
		 $db->query('UPDATE users SET `profile_image`='.$pic_id.' WHERE id='.$logged['id']); // ADDS PICTURE TO THE USER
	 }
	 
	 if (mysql_error()) die(); else echo $file_name;
?>
