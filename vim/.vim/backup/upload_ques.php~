<?php

require_once('database.php');

@ session_start();

$db = database::get_instance();
$category = $_POST['category'];

// if import from uploaded file (admin panel)
if (isset($_FILES['csv_file']['tmp_name'])) {
	$file = $_FILES['csv_file']['tmp_name'];
	$stream = fopen($file, 'r');
	$line_count = 0;

	if (is_uploaded_file($file)) {
		// skip the first header line
		// fgets($stream);

		while (true) {
			$line_count++;
			$line = fgets($stream);

			if (!$line)
				break;
			$db->format_string($line);

			$row = explode(",", $line);

			if ($row[0] == "")
				continue;

			if (count($row) < 1) {
				echo '{ "ret": "Error in file on line '.$line_count.'. 1-9 column needed." }';
				exit;
			}

			// calculate total amount of answers in a row
			$answer_count = 0;
			for (;;) {
				if ($row[++$answer_count] == '') {
					--$answer_count;
					break;
				}
			}

			$query = "INSERT INTO `".$category."_questions` (`answer_count`,`question`";
			if ($answer_count > 1) {
				for ($i = 1; $i <= $answer_count; $i++)
					$query .= ",`answer".$i."`";
			}
			$query .= ") VALUES (".$answer_count.",'".$row[0]."'";
			if ($answer_count > 1) {
				for ($i = 1; $i <= $answer_count; $i++)
					$query .= ",'".$row[$i]."'";
			}
			$query .= ")";

			$db->query($query);
			if (mysql_error())
				$line_count--;
		}
		fclose($stream);
		echo '{ "ret": "'.$line_count.' questions successfully added in category \''.$category.'\'<br/>" }';
	} else {
		echo '{ "ret": "Error with file upload." }';
	}
} else { // else if inserted in form
	if (!isset($_POST['cms-q']) || $_POST['cms-q'] === "") {
		echo '{ "ret": "Question field is not filled." }';
		exit;
	}

	if (isset($_POST['cms-a8']) && $_POST['cms-a8'] !== "")
		$answer_count = 8;
	else if (isset($_POST['cms-a7']) && $_POST['cms-a7'] !== "")
		$answer_count = 7;
	else if (isset($_POST['cms-a6']) && $_POST['cms-a6'] !== "")
		$answer_count = 6;
	else if (isset($_POST['cms-a5']) && $_POST['cms-a5'] !== "")
		$answer_count = 5;
	else if (isset($_POST['cms-a4']) && $_POST['cms-a4'] !== "")
		$answer_count = 4;
	else if (isset($_POST['cms-a3']) && $_POST['cms-a3'] !== "")
		$answer_count = 3;
	else if (isset($_POST['cms-a2']) && $_POST['cms-a2'] !== "")
		$answer_count = 2;
	else if (isset($_POST['cms-a1']) && $_POST['cms-a1'] !== "") {
		echo '{ "ret": "Error: A question cannot have 1 answer" }';
		exit;
	}	
	else // 1 == input question
		$answer_count = 0;

	foreach ($_GET as $key => $value)
		$db->format_string($value);

	if (isset($_SESSION['admin_username'])) {
		$query = "INSERT INTO `".$category."_questions`
			(`answer_count`,`question`,`answer1`,`answer2`,`answer3`,`answer4`,`answer5`,`answer6`,`answer7`,`answer8`) VALUES
			(".$answer_count.",'".$_POST['cms-q']."','".$_POST['cms-a1']."','".$_POST['cms-a2']."','".$_POST['cms-a3']."',
			'".$_POST['cms-a4']."','".$_POST['cms-a5']."','".$_POST['cms-a6']."','".$_POST['cms-a7']."','".$_POST['cms-a8']."')";
	} else {
		$query = "INSERT INTO `".$category."_questions`
			(`answer_count`,`question`,`answer1`,`answer2`,`answer3`,`answer4`,`answer5`,`answer6`,`answer7`,`answer8`,`created_by`) VALUES
			(".$answer_count.",'".$_POST['cms-q']."','".$_POST['cms-a1']."','".$_POST['cms-a2']."','".$_POST['cms-a3']."',
			'".$_POST['cms-a4']."','".$_POST['cms-a5']."','".$_POST['cms-a6']."','".$_POST['cms-a7']."','".$_POST['cms-a8']."',
			'".$_SESSION['username']."')";
	}
	$db->query($query);
	if (mysql_error())
		echo '{ "ret": "'.mysql_error().'" }';
	else
		echo '{ "ret": "Question successfully added in category \''.$category.'\'" }';
}

?>
