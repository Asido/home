<?php
if (isset($_GET['accept']) && isset($_GET['id'])) {
	$sql = mysql_fetch_array(mysql_query("SELECT `status` FROM `sax_custom_offers` WHERE `id` = ".$_GET['id']));
	if (strchr($sql['status'], 'endin') != '') {
		if ($_GET['accept'] == "true") {
			$sql = mysql_query("UPDATE `sax_custom_offers` SET `status` = 'Accepted' WHERE `id` = ".$_GET['id']);
			$sql = mysql_fetch_array(mysql_query("SELECT * FROM `sax_custom_offers` WHERE `id` = ".$_GET['id']));

			$message = "
				<html>
				<body>
					<b>Congratulations!</b><br/><br/>
					Your offer has been accepted.<br/>
					You can finish your purchase by clicking
					<a href=\"http://www.sax-ccessories.com/view/custom_offers.php?key=".$sql['unique_key']."\" target=\"_blank\">
					HERE</a><br/><br/>
					Thank you for shopping  at <a href=\"http://www.sax-ccessories.com/\" target=\"_blank\">www.SAX-CCESSORIES.com!</a>
					<br/><hr><br/>
					<font color=\"#353535\">SAX-CCESSORIES LLC<br/>www.sax-ccessories.com<br/>info@sax-ccessories.com</font>
				</body>
				</html>
			";
			$title = "Your offer has been accepted!";
		} else if ($_GET['accept'] == "false") {
			$sql = mysql_query("UPDATE `sax_custom_offers` SET `status` = 'Denied' WHERE `id` = ".$_GET['id']);
			$sql = mysql_fetch_array(mysql_query("SELECT * FROM `sax_custom_offers` WHERE `id` = ".$_GET['id']));
			$product = mysql_fetch_array(mysql_query("SELECT * FROM `sax_product` WHERE `id`=".$sql['product_id']));
			$message = "We are sorry, but your offer was rejected.\n";
			$message = "
				<html>
				<body>
					Dear, ".$sql['name'].",<br/><br/>
					We're sorry, but your offer for ".$sql['quantity']."
					<a href=\"http://www.sax-ccessories.com/products/".$sql['product_id']."\"target=\"_blank\">"
					.$product['productname'].' '.$product['title1'].' '.$product['title2']."</a> for $".$sql['offer'].",
				   	not including tax or shipping, has been rejected.<br/>
					Thank you for shopping at <a href=\"http://www.sax-ccessories.com/\" target=\"_blank\">www.SAX-CCESSORIES.com!</a>
					<br/><br/><hr><br/>
					<font color=\"#353535\">SAX-CCESSORIES LLC<br/>www.sax-ccessories.com<br/>info@sax-ccessories.com</font>
				</body>
				</html>
			";
			$title = "Your offer has been rejected.";
		} else if ($_GET['accept'] == "counter") {
			mysql_query("UPDATE `sax_custom_offers` SET `status` = 'Counter' WHERE `id` = ".$_GET['id']);
			$sql = mysql_fetch_array(mysql_query("SELECT * FROM `sax_custom_offers` WHERE `id` = ".$_GET['id']));
			$unique_key = sha1(microtime());
			mysql_query("INSERT `sax_admin_counter_offers` (`customer_offer_id`, `amount`, `unique_key`, `status`)
				VALUES ('".$sql['id']."', ".$_GET['price'].", '".$unique_key."', 'Pending')");
			$product = mysql_fetch_array(mysql_query("SELECT * FROM `sax_product` WHERE `id`=".$sql['product_id']));
			$message = "
				<html>
				<body>
					Dear, ".$sql['name'].",<br/><br/>
					Admin counter offer for ".$sql['quantity']."
					<a href=\"http://www.sax-ccessories.com/products/".$sql['product_id']."\"target=\"_blank\">"
					.$product['productname'].' '.$product['title1'].' '.$product['title2']."</a> is $".$_GET['price'].",
				   	not including tax or shipping.
					You can accept or deny this offer by navigating
					<a href=\"http://www.sax-ccessories.com/products/".$sql['product_id']."?oid=".$unique_key."\" target=\"_blank\">HERE</a><br/>
					Thank you for shopping at <a href=\"http://www.sax-ccessories.com/\" target=\"_blank\">www.SAX-CCESSORIES.com!</a>
					<br/><br/><hr><br/>
					<font color=\"#353535\">SAX-CCESSORIES LLC<br/>www.sax-ccessories.com<br/>info@sax-ccessories.com</font>
				</body>
				</html>
			";
			$title = "Your offer has been rejected, but...";
		}
		$class->sentmail($sql['email'], $title, "orders@sax-ccessories.com",$message);
	}
}
?>

<style>
tr, td, table {
	font-size: 11px !important;
}
</style>

<script type="text/javascript" language="javascript" src="../js/layerview.js"></script>
<script type="text/javascript" language="javascript" src="../js/jquery.js"></script>
<script type="text/javascript">
function SetChecked(val) 
{
	
	dml = document.form1;
	len = dml.elements.length;
	var i=0;
	for( i=0 ; i<len ; i++) 
	{
		if (dml.elements[i].id=='chk') 
			{	
			dml.elements[i].checked=val;}
	}
}

function input_price()
{
	var price = prompt("Enter your price");
	if (price != "" && !isNaN(price)) {
		var link = $("#counter-link");
		link.attr("href", link.attr("href") + "&price="+price);
		window.location = link.attr("href");
	}
	return false;
}
</script>
<script type="text/javascript">
function validatechkbox(form) 
{
// Checking if at least one period button is selected. Or not.
var total=0;
for(var i=0; i < document.form1.chk.length; i++)
{
if(document.form1.chk[i].checked)
total++;
}
if(total=="")
{
alert("Please select any one");
return false;
}
return true;
}
</script>
<?php
if(isset($_REQUEST['DeleteCustomer']))
{
	$count=mysql_num_rows(mysql_query("select * from sax_custom_offers order by id DESC"));
	for($i=0;$i<$count;$i++)
	{
		$del_id = $_POST['chk'][$i];
		$sql = "DELETE FROM sax_custom_offers WHERE id ='$del_id'";
		$result = mysql_query($sql);
	}
	if($result)
	echo $class->R("home.php?action=pending_offers&removed");
}
$totlist=$class->C($class->query("sax_custom_offers")." order by id DESC");
?>
<span class="procedures">
              <ul><span class="title">Custom Offers</span>
                <form name="form1" action="" method="post" onsubmit="return validatechkbox(this);">
					<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="bordersytle">
                    <tr>
                      <td height="25" align="left" valign="middle" class="green">&nbsp;
                      <?php 
					  if(isset($_GET['removed'])){echo "<span class='green'>Successfully History Removed</span>";}
					  ?>
                      </td>
                      </tr>
                    <tr>
                      <td width="41%" align="left" valign="middle" class="black12"><table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
                        <tr>
                          <td width="5%" align="left" valign="middle"><a href="javascript:SetChecked(1)" class="font12"><img src="../images/checkbox.png" title="Check All" border="0" /></a></td>
                          <td width="5%" align="left" valign="middle"><a href="javascript:SetChecked(0)" class="font12"><img src="../images/checkbox_no.png" border="0" title="Uncheck All" /></a></td>
                          <td height="30" align="left" valign="middle">
                          <input type="submit" name="DeleteCustomer" class="buttoncolor" value="Delete"/>
                          </td>
                          <td width="45%" align="right" valign="middle" class="black12" style="padding-right:20px;">Total Records : [<?php echo $totlist;?>]</td>
                        </tr>
                      </table></td>
                      </tr>
                    <tr>
                      <td align="left" valign="middle">
                      <table width="100%" border="0" cellspacing="0" cellpadding="0">
                        <tr style="background-image:url(../images/menu_bg.jpg);"> 
                          <td height="30" colspan="2" align="center" valign="middle">&nbsp;</td>
                          <td width="15%" align="center" valign="middle" class="white">Name</td>
                          <td width="20%" align="center" valign="middle" class="white">Email</td>
                          <td width="12%" align="center" valign="middle" class="white">Offer</td>
                          <td width="8%" align="center" valign="middle" class="white">Quantity</td>
                          <td width="14%" align="center" valign="middle" class="white">Shipping</td>
                          <td width="12%" align="center" valign="middle" class="white">Status</td>
                          <td width="18%" align="center" valign="middle" class="white">Accept / Deny / Counter</td>
                        </tr>
                        <?php
                        $list=$class->Q($class->query("sax_custom_offers")." order by id DESC");
						while($history=$class->E($list)){
						?>
                        <tr>
                          <td width="4%" align="center" valign="middle"><input type="checkbox" name="chk[]" id="chk" value="<?php echo $history['id']?>"/>                          </td>
                          <td width="3%" align="center" valign="middle">
                          <a href="#" onclick="MM_showHideLayers('Layer1<?php echo $history['id'];?>','','show')">
                          <img src="../images/Search.png" border="0" title="Info." /></a>
                          </td>
                          <td height="25" align="center" valign="middle" class="black12"><?php echo $history['name']; ?></td>
                          <td align="center" valign="middle" class="black12"><?php echo $history['email']?></td>
                          <td align="center" valign="middle" class="black12">$<?php echo $history['offer']?></td>
                          <td align="center" valign="middle" class="black12"><?php echo $history['quantity']?></td>
                          <td align="center" valign="middle" class="black12"><?php echo $history['shipping']?></td>
                          <td align="center" valign="middle" class="black12"><?php echo $history['status']?></td>
						  <td align="center" valign="middle" class="black12">
							<?php if (strchr($history['status'], 'endin') != '') { ?>
							  <a href="home.php?action=pending_offers&accept=true&id=<?php echo $history['id'] ?>" onclick="function() {confirm('you sure?');}">A</a> / 
							  <a href="home.php?action=pending_offers&accept=false&id=<?php echo $history['id'] ?>">D</a> /
							  <a id="counter-link" href="http://www.sax-ccessories.com/Sax/home.php?action=pending_offers&accept=counter&id=<?php echo $history['id'] ?>" onclick="return input_price();">C</a>
							<?php } ?>
						  </td>
                        </tr>
                        <tr>
                          <td height="1" colspan="9" align="center" valign="middle" bgcolor="#CCCCCC"></td>
                        </tr>
                        <?php }?>
                      </table></td>
                      </tr>
                      <?php
                      $totlist=$class->C($class->query("sax_custom_offers")." order by id DESC");
					  if($totlist<=0){
					  ?>
                    <tr>
                      <td height="25" align="left" valign="middle" class="red">~ No Records Found ~</td>
                      </tr>
                      <?php }?>
                    <tr>
                      <td align="left" valign="middle">&nbsp;</td>
                      </tr>
                    <tr>
                      <td align="left" valign="middle" class="black12">&nbsp;</td>
                      </tr>
                    <tr>
                      <td align="left" valign="middle">&nbsp;</td>
                      </tr>
                    <tr>
                      <td align="left" valign="middle">&nbsp;</td>
                      </tr>
                    <tr>
                      <td align="left" valign="middle">&nbsp;</td>
                      </tr>
                  </table>
                  </form>
              </ul>
            </span>
<?php
$val=mysql_query("select * from sax_custom_offers order by id DESC");
while($details=mysql_fetch_array($val))
{	
$product = mysql_fetch_array(mysql_query("SELECT * FROM `sax_product` WHERE `id` = ".$details['product_id']));
?>
<div id="Layer1<?php echo $details['id'];?>" style="position:absolute; width:695px; height:110px; z-index:1; left: 280px; top: 190px; visibility: hidden; border: 0px none #CADFFB" class="txtborder">
  <table width="100%"  border="0" cellpadding="0" cellspacing="1" style="background-color:#999;">

    <tr>
      <td>
      <table width="105%" height="59%" border="0" align="center" cellpadding="0" cellspacing="0" class="0" ID="Table11" >
        <tr>
          <td height="30" colspan="2" align="left" bgcolor="#333" class="title">
            <table width="100%" border="0" align="center" cellpadding="0" cellspacing="0">
              <tr>
                <td width="92%" align="left" valign="middle">&nbsp;&nbsp;Offer Details</td>
                <td width="8%" align="center" valign="middle"><a href="#" class="a_green" onClick="MM_showHideLayers('Layer1<?php echo $details['id'];?>','','hide')">
              <img src="../images/close1.jpg" border="0" alt="Close" title="Close"></a>&nbsp;</td>
                </tr>
              </table>
                      </td>
          </tr>
        <tr align="left" valign="middle" bgcolor="#F4F4F4">
          <td height="27" class="font3">&nbsp;&nbsp;&nbsp;Product Details</td>
          <td class="font3">&nbsp;</td>
        </tr>
        <tr align="left" valign="middle" bgcolor="#E4E4E4">
          <td width="23%" height="27" class="font2">&nbsp;&nbsp;&nbsp;Product Name</td>
		  <td width="77%" class="font3"><span class="font2">
				<?php echo $product['productname'].' '.$product['title1'].' '.$product['title2'];?></span></td>
        </tr>
        <tr align="left" valign="middle" bgcolor="#F4F4F4">
          <td height="27" class="font2">&nbsp;&nbsp;&nbsp;Product Price</td>
          <td height="27" class="font3"><span class="font2">$ <?php echo $product['cost'];?></span></td>
        </tr>
        <tr align="left" valign="middle" bgcolor="#E4E4E4">
          <td height="27" class="font2">&nbsp;&nbsp;&nbsp;Product URL</td>
		  <td height="27" class="font3"><span class="font2">
			<?php echo '<a href="http://www.sax-ccessories.com/products/'.$product['id'].'" target="_blank">http://www.sax-ccessories.com/products/'.$product['id'].'</a>';?></span></td>
          </tr>
        <tr align="left" valign="middle" bgcolor="#F4F4F4">
          <td height="27" class="font3">&nbsp;&nbsp;&nbsp;Customer Details</td>
          <td class="font3">&nbsp;</td>
        </tr>
        <tr align="left" valign="middle" bgcolor="#E4E4E4">
          <td height="27" class="font2">&nbsp;&nbsp;&nbsp;Name</td>
          <td class="font3"><span class="font2"><?php echo $details['name'];?></span></td>
        </tr>
        <tr align="left" valign="middle" bgcolor="#F4F4F4">
          <td height="27" class="font2">&nbsp;&nbsp;&nbsp;E-mail</td>
          <td class="font3"><span class="font2"><?php echo $details['email'];?></span></td>
        </tr>
        <tr align="left" valign="middle" bgcolor="#E4E4E4">
          <td height="27" class="font2">&nbsp;&nbsp;&nbsp;Offer</td>
          <td class="font3"><span class="font2">$ <?php echo $details['offer'];?></span></td>
        </tr>
        <tr align="left" valign="middle" bgcolor="#F4F4F4">
          <td height="27" class="font2">&nbsp;&nbsp;&nbsp;Quantity</td>
          <td class="font3"><span class="font2"><?php echo $details['quantity'];?></span></td>
        </tr>
        <tr align="left" valign="middle" bgcolor="#E4E4E4">
          <td height="27" class="font3">&nbsp;&nbsp;&nbsp;Offer Status</td>
          <td class="font3"><span class="font3"><?php echo $details['status'];?></span></td>
        </tr>
        <tr align="left" valign="middle">
             <td height="27" bgcolor="#F4F4F4" class="font2" style="padding-left:10px;">&nbsp;</td>
             <td height="27" bgcolor="#F4F4F4" class="font2" style="padding-left:10px;">&nbsp;</td>
           </tr>
		<tr align="left" valign="middle">
		  <td height="1" colspan="2" bgcolor="#FFFFFF" class="font12_black"></td>
		  </tr>
      </table></td>
    </tr>
  </table>
</div>
<?php }?>                    

<style>
#input-price {
	position: fixed;
	top: 50%;
	bottom: 50%;
	display: none;
}
</style>
<div id="input-price">
	Type your price: 
	<input type="text" name="price" />
</div>
