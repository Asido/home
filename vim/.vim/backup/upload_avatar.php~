<?php
@session_start();

if (!isset($_FILES['avatar-file']))
	exit;

require_once('config.php');
require_once('lib/imghandler.php');
require_once('database.php');

$ext = explode('.', $_FILES['avatar-file']['name']);
$ext = $ext[count($ext)-1];
$filename = sha1(time().$_FILES['avatar-file']['tmp_name']).'.'.$ext;
while (file_exists('../'.CONFIG::AVATAR_DIR.$filename))
	$filename = sha1(time().$_FILES['avatar-file']['tmp_name'].'.'.$ext);

if (!move_uploaded_file($_FILES['avatar-file']['tmp_name'], '../'.CONFIG::AVATAR_DIR.$filename)) {
	echo '{"ret" : "error moving the image"}';
	exit;
}

switch ($ext) {
case 'png':
	$image = imagecreatefrompng('../'.CONFIG::AVATAR_DIR.$filename);
	break;
case 'jpg':
case 'jpeg':
	$image = imagecreatefromjpeg('../'.CONFIG::AVATAR_DIR.$filename);
}
$thumb = imagecreatetruecolor(96, 93);
imagecopyresampled($thumb, $image, 0, 0, 0, 0, 96, 93, imagesx($image), imagesy($image));
switch ($ext) {
case 'png':
	imagepng($thumb, '../'.CONFIG::AVATAR_DIR.$filename, 100);
	break;
case 'jpg':
case 'jpeg':
	imagejpeg($thumb, '../'.CONFIG::AVATAR_DIR.$filename, 100);
}


$db = database::get_instance();
$query = "UPDATE `users` SET `avatar_filename`='".$filename."' WHERE `username`='".$_SESSION['username']."'";
if ($db->query($query))
	echo '{"ret" : "'.$filename.'"}';
else
	echo '{"ret" : "Error setting the avatar"}';
exit;
?>
