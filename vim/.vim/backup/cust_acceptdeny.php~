<html>
<head>
<script type="text/javascript" src="js/jquery-1.3.2.min.js"></script>
<script language="javascript">
$(window).ready(function() {
	$("#accept-button").click(function() {
		window.location += "&accepted=true";
	});
	$("#deny-button").click(function() {
		window.location += "&accepted=false";
	});
});
</script>
</head>
<body>
<?php

foreach($_GET as $key => $value)
	$_GET[$key] = mysql_real_escape_string(stripslashes($value));
foreach($_POST as $key => $value)
	$_POST[$key] = mysql_real_escape_string(stripslashes($value));

$db = mysql_pconnect('localhost', 'brian393_admindb', 'bgs@321');
$db = mysql_select_db('brian393_brian0393');


if (isset($_GET['oid'])) {
	$sql = mysql_query("SELECT * FROM `sax_admin_counter_offers` WHERE `unique_key`='".$_GET['oid']."'");
	if (!$sql) {
		echo "The offer has been expired.\n";
		exit;
	}
	$admin_sql = mysql_fetch_array($sql);
	$customer_sql = mysql_fetch_array(mysql_query("SELECT * FROM `sax_custom_offers` WHERE `id`=".$admin_sql['customer_offer_id']));
	$product_sql = mysql_fetch_array(mysql_query("SELECT * FROM `sax_product` WHERE `id`=".$customer_sql['product_id']));

	if (isset($_GET['accepted'])) {
		if ($_GET['accepted'] == "true") {
			mysql_query("UPDATE `sax_admin_counter_offers` SET `status`='Accepted' WHERE `unique_key`='".$_GET['oid']."'");
			mysql_query("INSERT INTO `sax_custom_offers`
				(`product_id`, `name`, `email`, `offer`, `quantity`, `status`, `unique_key`, `shipping`) VALUES
				(".$customer_sql['product_id'].", '".$customer_sql['name']."', '".$customer_sql['email']."', ".$admin_sql['amount'].",
				".$customer_sql['quantity'].", 'Accepted', '".$admin_sql['unique_key']."', '".$customer_sql['shipping']."')");
			if (mysql_error()) {
				echo "You have already accepted / denied the offer.";
				exit;
			}

			$message = "Press <a href=\"http://www.sax-ccessories.com/view/custom_offers.php?key=".$admin_sql['unique_key']."\" target=\"_blank\">HERE</a> to checkout.";
			require_once('inc/class.php');
			$class = new sax;
			$class->sentmail($customer_sql['email'], "Checkout link", "orders@sax-ccessories.com",$message);

			echo "You have accepted the offer. Check your e-mail for checkout link.\n";
		} else if ($_GET['accepted'] == "false") {
			mysql_query("UPDATE `sax_admin_counter_offers` SET `status`='Denied' WHERE `unique_key`='".$_GET['oid']."'");
?>
			<script language="javascript">
			window.location =
					"http://www.sax-ccessories.com/products/<?php echo $product_sql['id']; ?>?id=<?php echo $customer_sql['id']; ?>&counter";
			</script>
<?php
		}
		exit;
	}

	if ($admin_sql['status'] == "Pending") {
		echo 'We offer you '.$customer_sql['quantity'].'
			<a href="http://www.sax-ccessories.com/products/'.$product_sql['id'].'" target="_blank">'.$product_sql['productname'].'
		   	'.$product_sql['title1'].' '.$product_sql['title2'].'</a> for $'.$admin_sql['amount'].'.<br/>Choose one of the options below.';
?>
		<br/>
		<input id="accept-button" type="button" name="accepted" value="Accept" />
		<input id="deny-button" type="button" name="denied" value="Deny" />
<?php
	} else
		echo '<p>You have already '.strtolower($sql['status']).' the offer.</p>';
}
?>
</body>
</html>
