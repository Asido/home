<?
@session_start();

require_once('php/database.php');		
require_once 'php/group_users.php';

$db = database::get_instance();

$keywords = $_POST['search_question'];
$page = $_POST['page'];
//print $page;
//print $page;
//$keywords = 'music';

$keywords_array = array();
$keywords_array = explode(" ",$keywords);

$where = " WHERE question LIKE '%";
foreach($keywords_array as $key){
	$where .= $key."%";
}
$where .= "'";

$questions = array();
$questions_nr = 0;

search_questions($questions, $questions_nr, 'group', $where, $db);
search_questions($questions, $questions_nr, 'profile', $where, $db);
search_questions($questions, $questions_nr, 'top100', $where, $db);
search_questions($questions, $questions_nr, 'top10', $where, $db);

//SORT ARRAY
for($i=1; $i<=count($questions)-1; $i++){
	for($j=$i+1; $j<=count($questions); $j++){
		if($questions[$i]['answers']<$questions[$j]['answers']){
			$aux = $questions[$i];
			$questions[$i] = $questions[$j];
			$questions[$j] = $aux;
		}
	}
}

print_questions($questions, $questions_nr, $page);


function print_questions($v, $n, $p){
	$i = $p * 10 - 9;
	while(($i <= $n) && ($i <= $p*10)){
		if($i==($p * 10 - 9)){
			print
				"<div class=\"si-maininner\"><p style=\"font-family:Arial, Helvetica, sans-serif; font-size:16px; color:#252929; margin-left:7px; margin-top:13px; float:left;\">".$v[$i]['id']." ".$v[$i]['question']."</p><div class=\"si-view\"><a href=\"profques.php?category=".$v[$i]['id']."&Qid=".$v[$i]['id']."\">View</a></div></div>";
		}else{
			print 
				"<div class=\"si-maininner\"><p style=\"font-family:Arial, Helvetica, sans-serif; font-size:16px; color:#252929; margin-left:7px; margin-top:13px; float:left;\">".$v[$i]['id']." ".$v[$i]['question']."</p><div class=\"si-view\"><a href=\"profques.php?category=".$v[$i]['id']."&Qid=".$v[$i]['id']."\">View</a></div></div>";
		}
		$i++;
	}
	//print $p;
	if(($n > $p*10) && ($p != 1)){
		print "<input type=\"hidden\" id=\"h_prev\" name=\"h_prev\" value=\"1\"><input type=\"hidden\" id=\"h_next\" name=\"h_next\" value=\"1\"><input type=\"hidden\" id=\"h_page_nr\" name=\"h_page_nr\" value=\"".$p."\">";
	}elseif(($p == 1) && ($n > $p*10)){
		print "<input type=\"hidden\" id=\"h_prev\" name=\"h_prev\" value=\"0\"><input type=\"hidden\" id=\"h_next\" name=\"h_next\" value=\"1\"><input type=\"hidden\" id=\"h_page_nr\" name=\"h_page_nr\" value=\"".$p."\">";
	}elseif(($p != 1) && ($n <= $p*10)){
		print "<input type=\"hidden\" id=\"h_prev\" name=\"h_prev\" value=\"1\"><input type=\"hidden\" id=\"h_next\" name=\"h_next\" value=\"0\"><input type=\"hidden\" id=\"h_page_nr\" name=\"h_page_nr\" value=\"".$p."\">";
	}else{
		print "<input type=\"hidden\" id=\"h_prev\" name=\"h_prev\" value=\"0\"><input type=\"hidden\" id=\"h_next\" name=\"h_next\" value=\"0\"><input type=\"hidden\" id=\"h_page_nr\" name=\"h_page_nr\" value=\"".$p."\">";
	}

	
}

function search_questions(&$v, &$n, $obj, $key, $db){ 						 	
	mysql_real_escape_string(stripslashes($obj));
	mysql_real_escape_string(stripslashes($key));

	$search = "SELECT id, question FROM ".$obj."_questions".$key;
	$result = $db->query($search);
	while($data = mysql_fetch_array($result)){
		$n++;
		$v[$n]['id'] = $data['id'];
		$v[$n]['question'] = $data['question'];
		$v[$n]['category'] = $obj;
	
		$select_answers = "SELECT COUNT(question_id) AS nr FROM ".$obj."_answers WHERE question_id='".$v[$n]['id']."'";
		$answers_nr = $db->query($select_answers);
		$answers = mysql_fetch_array($answers_nr);
	
		$v[$n]['answers'] = $answers['nr'];
	}
}
/*
function merge_sort($m){
    if (count($m) <= 1)
        return $m;
    $left = array();
	$right = array();
	$result = array();
	$middle = count($m) / 2;
    for($i=1; $i<=$middle; $i++)
         array_push($left, $m[$i]);
    for($i=$middle+1; $i<=count($m); $i++)
         array_push($left, $m[$i]);
    $left = merge_sort($left);
    $right = merge_sort($right);
    $result = merge($left, $right);
    return $result;
}

function merge($left,$right){
    $result = array();
    while ((count($left) > 0) or (count(right) > 0)){
        if ((count($left) > 0) and (count(right) > 0)){
            if ($left[1] <= $right[1]){
                array_push($result,$left[1]);
                for($i=1; $i<count($left); $i++)
					$left[$i] = $left[$i+1];				
            }else{
                array_push($result,$right[1]);
                for($i=1; $i<count($right); $i++)
					$right[$i] = $right[$i+1];				
			}
        }else{
			if (count($left) > 0){
				array_push($result,$left[1]);
                for($i=1; $i<count($left); $i++)
					$left[$i] = $left[$i+1];				
        	}else if (count($right) > 0){
				array_push($result,$right[1]);
                for($i=1; $i<count($right); $i++)
					$right[$i] = $right[$i+1];				
			}
		}
    }
    return $result;
}
*/
?>
