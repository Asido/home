<?php

session_start();

function mysql_querp($query)

{

	echo $query."<br><br>";

	$q = mysql_query($query);
	echo $q;
	echo mysql_error();
	return $q;

}

require_once("funcsv.php");

connect();

//echo "<pre>";


//print_r($_POST);




$user_id =$_SESSION['user_id'];

$videotype=mysql_real_escape_string($_POST['videotype']);

$location = mysql_real_escape_string($_POST['location']);

$tour_id=mysql_real_escape_string($_POST['tour_id']); 

$maptype=mysql_real_escape_string($_POST['maptype']);

$svmapurl = mysql_real_escape_string($_POST['sv_mapurl']);

$vtype = mysql_real_escape_string($_POST['videotype']);

$title =mysql_real_escape_string($_POST['title']) ;

$description=mysql_real_escape_string($_POST['description']) ;

$tags=mysql_real_escape_string($_POST['tags']);

$categoryid=mysql_real_escape_string($_POST['category']);

$language=mysql_real_escape_string($_POST['language']) ;

$location=mysql_real_escape_string($_POST['location']) ;

$countryid=mysql_real_escape_string($_POST['country']) ;

$linaudio=mysql_real_escape_string($_POST['linaudio']) ;

$linvideo=mysql_real_escape_string($_POST['linvideo']) ;

$tourstatus=mysql_real_escape_string($_POST['tourstatus']) ;

$price=mysql_real_escape_string($_POST['price']) ;

$images = $_SESSION['images'];

//$videos = $_SESSION['videos'];

if(isset($_POST['cart1']))
{
	if($_POST['cart1']!="")
	{
		$cart1 = "on";

	}
}
if(isset($_POST['cart2']))
{
	if($_POST['cart2']!="")
	{
		$cart2 = "on";

	}
}


//setting city_id

$r = mysql_querp("SELECT * from city where city_name='".$location."'");

if(mysql_num_rows($r)>0)

{

	$onerow= mysql_fetch_array($r);

	$city_id = $onerow['city_id'];

	



}

else

{

	$r = mysql_querp("INSERT into city values('',".$countryid.",'".$location."')");

	$city_id = mysql_insert_id();

	//echo "city not found inserted<br />";

}

if($maptype=="google")

{

	$svmapurl.="&amp;output=embed";

}

//setting map_id

$r = mysql_querp("INSERT INTO webeteer_yt.maps (map_id, map_type, link, status) VALUES ('', '".$maptype."', '".$svmapurl."', 1)");

$map_id = mysql_insert_id();

//echo "</br>Got map id :".$map_id;



//setting album_id

$len = count($images);

for($imagenum=0;$imagenum<$len;$imagenum++)
{
	$picpath = $images[$imagenum]['path'];
	$r = mysql_querp("INSERT INTO album (album_id ,pic_path)VALUES (".$tour_id.",'".$picpath."')");
}
//echo "</br>Got album count:".$len;
//setting video

for ($len = 0;; $len++) {
	if (!isset($_POST['video'.$len]))
		break;
}
//$len = count($videos);

// echo "<b>no.of videos</b>=".$len;

if($len>0)

{

	if($len==1)

	{

		$mainvideo = $_POST['video0'];//$videos[1]['tmpname'];

		$intro="";

	}

	else

	{

		$mainvideo = $_POST['video0'];//$videos[1]['tmpname'];

		$intro=	$_POST['video1'];//$videos[2]['tmpname'];

	}
}	


$r =mysql_querp("INSERT INTO videos VALUES ('', '".$videotype."', '".$mainvideo."', '".$intro."', '".$linvideo."')");

$video_id = mysql_insert_id();

//echo "</br>Got video id :".$video_id;

// setting audio file
for ($len = 0;; $len++) {
	if (isset($_POST['audio'.$len]))
		mysql_querp("INSERT INTO `audio` (`path`,`tour_id`) VALUES ('".$_POST['audio'.$len]."',".$tour_id.")");
	else
		break;
}

//setting cart

if($cart1=="on")

{

	$featured=2;

}

else

{

	$featured=0;

}

if($cart2=="on")

{

	$etravels=2;

}

else

{

	$etravels=0;

}



//echo "</br>Got cart:".$featured.$etravels;

//to tour_details

//

$status=1;

if($tourstatus=='save')

{

	$status=1;

	

}

else if($tourstatus=='submit')

{

	$status=2;

}

$query = "INSERT INTO `tour_details` (`tour_id`,`title`,`description`,`tags`,`category_id`,`language_id`,`city_id`,`audio_length`,
	`lw_length`,`price`,`featured`,`etravels`,`map_id`,`album_id`,`video_id`,`status`,`user_id`) VALUES
	(".$tour_id.",'".$title."','".$description."','".$tags."','".$categoryid."',".$language.",".$city_id.",'".$linaudio."',
	'".$linvideo."','".$price."','".$featured."','".$etravels."',".$map_id.",".$tour_id.",".$video_id.",".$status.",".$user_id.")";

mysql_querp($query); 

//echo $query;

unset($_SESSION['images']);

unset($_SESSION['uploadcount']);

unset($_SESSION['googleurl']);

unset($_SESSION['googlelink']);

unset($_SESSION['videos']);

function addToCart($tour_id,$etravels=false,$featured=false)

{

	if(isset($_SESSION['cart']))

	{

		$count = count($_SESSION['cart']);

		$_SESSION['cart'][$count]['tour_id'] = $tour_id;

		$_SESSION['cart'][$count]['etravels'] = ($etravels==true)?true:false;

		$_SESSION['cart'][$count]['featured'] = ($featured==true)?true:false;

	}

	else

	{

		$_SESSION['cart'][0]['tour_id'] =  $tour_id;

		$_SESSION['cart'][0]['etravels'] = ($etravels==true)?true:false;

		$_SESSION['cart'][0]['featured'] = ($featured==true)?true:false;

	}

}

if($featured==2 && $etravels==2)

{

	addToCart($tour_id,true,true);

	header("location:mycart.php");

	

}

else if($featured==2 && $etravels==0)

{

	addToCart($tour_id,true,false);

	header("location:mycart.php");

}

else if($featured==0 && $etravels==2)

{

	addToCart($tour_id,false,true);

	header("location:mycart.php");

}

else if($featured==0 && $etravels==0)

{

	addToCart($tour_id,false,false);

	header("location:uploadtours.php?success&id=".$tour_id);

}

//

?>
