<?php
if(isset($_POST['SubmitSubCategory']))
{
	if(isset($_GET['edit']))
	$str="UPDATE ".TB_SUBCATEGORY." SET categoryid='".$_POST['txtcategory']."',subcategory='".$_POST['txtsubcategory']."' where id='".$_GET['edit']."'";	
	else
	{
	$new_priority = mysql_fetch_array(mysql_query("SELECT MAX(`priority`), `categoryid` FROM ".TB_SUBCATEGORY." WHERE `categoryid`=".$_POST['txtcategory']));
	$new_priority = max($new_priority[0] + 1, $new_priority[1] * 100);
	$str="INSERT INTO ".TB_SUBCATEGORY." SET categoryid='".$_POST['txtcategory']."',subcategory='".$_POST['txtsubcategory']."',priority=".$new_priority;
	}
	
	$exe=$class->Q($str);
	if($exe)
	echo $class->R("home.php?action=subcategory&catg=".$_GET['catg']."&succ");
	else
	echo $class->R("home.php?action=subcategory&catg=".$_GET['catg']."&err");
}
if(isset($_GET['delete']))
{
	$priority = mysql_fetch_array(mysql_query("SELECT `priority` FROM ".TB_SUBCATEGORY." WHERE `id`=".$_GET['delete']));
	$del = $class->Q($class->del(TB_SUBCATEGORY,"id",$_GET['delete']));
	$upd = mysql_query("UPDATE ".TB_SUBCATEGORY." SET `priority`=`priority`-1 WHERE `categoryid`=".$_GET['catg']." AND `priority`>".$priority[0]);
	if($del && $upd)
		echo $class->R("home.php?action=subcategory&catg=".$_GET['catg']."&removed");
}


$qry = "SELECT `sax_subcategory`.`priority`
						FROM `sax_subcategory`
						JOIN `sax_category`
						ON `sax_subcategory`.`categoryid` = ".(isset($_GET['catg']) && $_GET['catg'] != "" ? $_GET['catg'] : "`sax_category`.`id`")."
						GROUP BY `sax_subcategory`.`priority`
						ORDER BY `sax_category`.`priority` ASC , `sax_subcategory`.`priority` ASC";
// echo $qry;
$count_qry = mysql_query($qry);
$result_count = mysql_num_rows($count_qry);
if ($result_count > 1) {
	$temp = mysql_fetch_array($count_qry);
	$count_data[0] = $temp[0];
	mysql_data_seek($count_qry, $result_count - 1);
	$temp = mysql_fetch_array($count_qry);
	$count_data[1] = $temp[0];
} else {
	$temp = mysql_fetch_array($count_qry);
	$count_data[0] = $temp[0];
	$count_data[1] = $temp[0];
}
// echo $temp[0]." | ".$temp[1]."\n";
// echo $result_count;

if(isset($_REQUEST['perform']))
{
	if($_REQUEST['perform'] == "down") 
	{
		$order_qry= mysql_query("update ".TB_SUBCATEGORY." set priority =".$_REQUEST['order_id']." where priority =".($_REQUEST['order_id']+1));			
		$order_qry=mysql_query("update ".TB_SUBCATEGORY." set priority =".($_REQUEST['order_id']+1)." where id =".$_REQUEST['id']);
	}
	if($_REQUEST['perform'] == "up") 
	{
		$order_qry= mysql_query("update ".TB_SUBCATEGORY." set priority =".$_REQUEST['order_id']." where priority =".($_REQUEST['order_id']-1));
		$order_qry=mysql_query("update ".TB_SUBCATEGORY." set priority =".($_REQUEST['order_id']-1)." where id =".$_REQUEST['id']);
	}
}

$edit=@$class->F($class->where(TB_SUBCATEGORY,"id",$_GET['edit']));
?>
<script type="text/javascript" language="javascript">
function showcatg(str,edit)
{
	if(edit!="")
	window.location='home.php?action=subcategory&catg='+str+'&edit='+edit;
	else
	window.location='home.php?action=subcategory&catg='+str;
}
</script>
<script>
function order_record(url)
{
  window.location.href="home.php?action=subcategory&view" + url;
}

</script>
<span class="procedures">
              <ul><span class="title">Product Sub-Category</span>
                <form name="form1" action="" method="post" onsubmit="return catgvalid();">
					<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="bordersytle">
                    <tr>
                      <td width="37%" height="25" align="left" valign="middle">&nbsp;
                      </td>
                      <td width="63%" align="left" valign="middle">&nbsp;
                      <?php
                      if(isset($_GET['succ'])){echo "<span class='green'>Successfully Sub-Category Saved</span>";}
					  if(isset($_GET['err'])){echo "<span class='red'>Error, please try again</span>";}
					  ?>
                      </td>
                      </tr>
                    <tr>
                      <td align="right" valign="middle" class="black12" style="padding-right:50px;">Category</td>
                      <td align="left" valign="middle" class="black12">
                      <select name="txtcategory" id="txtcategory" class="txtborder" onchange="showcatg(this.value,'<?php echo @$_GET['edit']?>');">
                      <option value="">- Select -</option>
                      <?php 
					  $catg=@$class->Q($class->query(TB_CATEGORY)." order by priority ASC");
					  while($item=@$class->E($catg)){
					  ?>
                      <option <?php 
					  if(isset($_GET['edit']))
					  {
					  if($edit['categoryid']==$item['id']){echo "selected";}
					  }
					  else
					  {
					  	if(isset($_GET['catg'])){if($_GET['catg']==$item['id']){echo "selected";}}
					  }
					  ?> value="<?php echo $item['id']?>"><?php echo $item['category']?></option>
                      <?php }?>
                      </select>
                      </td>
                    </tr>
                    <tr>
                      <td align="left" valign="middle" class="black12">&nbsp;</td>
                      <td align="left" valign="middle" class="red">&nbsp;</td>
                    </tr>
                    <tr>
                      <td align="right" valign="middle" class="black12" style="padding-right:50px;">Sub-Category</td>
                      <td align="left" valign="middle" class="red"><span class="black12">
                        <input type="text" name="txtsubcategory" id="txtsubcategory" class="txtborder" value="<?php echo $edit['subcategory']?>" />
                      </span></td>
                    </tr>
                    <tr>
                      <td align="left" valign="middle" class="black12">&nbsp;</td>
                      <td align="left" valign="middle" class="red">&nbsp;<span id="r1"></span></td>
                    </tr>
                    <tr>
                      <td height="40" align="left" valign="middle">&nbsp;</td>
                      <td align="left" valign="middle">
                      <input type="submit" name="SubmitSubCategory" class="buttonbg" value="<?php echo $but=(isset($_GET['edit']))? "Update" : "Add";?>" /></td>
                    </tr>
                    <tr>
                      <td align="left" valign="middle"><?php if(isset($_GET['removed'])){echo "<span class='green'>Successfully Category Removed</span>";}?></td>
                      <td align="left" valign="middle">&nbsp;</td>
                    </tr>
                  </table>
                  </form>
              </ul>
              <ul><span class="title">List of Sub-Categories</span>
              <form name="form1" action="" method="post">
					<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="bordersytle">
                    <?php 
					  $qry=$class->query(TB_CATEGORY)." order by `".TB_CATEGORY."`.`priority` ASC";
					  $list=@$class->Q($qry);
					  while($category=@$class->E($list)){
						if(isset($_GET['catg']) && $_GET['catg'] != '') {
							$qry = "SELECT * FROM `".TB_SUBCATEGORY."` WHERE `categoryid`=".$_GET['catg']." order by `".TB_SUBCATEGORY."`.`priority` ASC";
						} else {
							$qry = "SELECT `".TB_CATEGORY."`.`priority` AS `category_priority`,
										   `".TB_SUBCATEGORY."`.`priority`,
										   `".TB_SUBCATEGORY."`.`subcategory`,
										   `".TB_SUBCATEGORY."`.`categoryid`,
										   `".TB_SUBCATEGORY."`.`id`
									FROM `".TB_SUBCATEGORY."`
									JOIN `".TB_CATEGORY."` ON `".TB_CATEGORY."`.`id` = `".TB_SUBCATEGORY."`.`categoryid`
									GROUP BY `".TB_SUBCATEGORY."`.`priority`
									ORDER BY `".TB_CATEGORY."`.`priority` ASC , `".TB_SUBCATEGORY."`.`priority` ASC";
						}
						
						$list=@$class->Q($qry);
						while($category=@$class->E($list)){
							echo $category['priority']."\n";
						?>
						<tr>
						  <td width="11%" height="30" align="center" valign="middle" class="black12">
						  <a href="home.php?action=subcategory&edit=<?php echo $category['id']?>&catg=<?php echo $category['categoryid'];?>">
						  <img src="../images/edit.png" border="0" title="Edit" /></a>&nbsp;
						  <a href="home.php?action=subcategory&delete=<?php echo $category['id']?>&catg=<?php echo $category['categoryid'];?>" onclick="return confirm('Are you sure want to Delete this?');">
						  <img src="../images/button_delete.gif" border="0" title="Delete" /></a>
						  </td>
						  <td width="9%" align="center" valign="middle" class="black12">
							<?php if(isset($_GET['catg']) && $_GET['catg'] != '') { ?>
							  <?php if($category['priority']==$count_data[0] && $count_data[0] != $count_data[1]){?>
								<a href="javascript:void(0);">
								<img border="0" onClick="order_record('&perform=down&order_id=<?php echo $category['priority']?>&id=<?php echo $category['id']; echo (isset($_GET['catg']) && $_GET['catg'] != '' ? '&catg='.$_GET['catg'] : '' ); ?>')" align="absmiddle" src="../images/pri_down.png" alt="down" title="down"></a>&nbsp;
								<?php } else if($category['priority']==$count_data[1] && $count_data[0] != $count_data[1]){?>
								<a href="javascript:void(0);"><img border="0" onClick="order_record('&perform=up&order_id=<?php echo $category['priority']?>&id=<?php echo $category['id']; echo (isset($_GET['catg']) && $_GET['catg'] != '' ? '&catg='.$_GET['catg'] : '' );?>')" align="absmiddle" src="../images/pri_up.png" alt="UP" title="UP"></a>&nbsp;
								<?php } else if($count_data[1] != $count_data[0]) {?>
								<a href="javascript:void(0);"><img border="0" onClick="order_record('&perform=down&order_id=<?php echo $category['priority']?>&id=<?php echo $category['id']; echo (isset($_GET['catg']) && $_GET['catg'] != '' ? '&catg='.$_GET['catg'] : '' ); ?>')" align="absmiddle" src="../images/pri_down.png" alt="down" title="down"></a>&nbsp;
								<a href="javascript:void(0);"><img border="0" onClick="order_record('&perform=up&order_id=<?php echo $category['priority']?>&id=<?php echo $category['id']; echo (isset($_GET['catg']) && $_GET['catg'] != '' ? '&catg='.$_GET['catg'] : '' ); ?>')" align="absmiddle" src="../images/pri_up.png" alt="UP" title="UP"></a>
								<?php } ?>
							<?php } ?>
						  </td>
						  <td width="80%" align="left" valign="middle" class="black12"><?php echo $category['subcategory']?></td>
						</tr>
						<tr>
						  <td height="1" colspan="3" align="left" valign="middle" bgcolor="#CCCCCC" class="black12"></td>
						  </tr>
						<?php }
					  }
					$totlist=$class->C($class->query(TB_SUBCATEGORY));
					if($totlist<=0){
					?>
                    <tr>
                      <td align="left" valign="middle" class="black12">&nbsp;</td>
                      <td colspan="2" align="left" valign="middle" class="red">&nbsp;</td>
                    </tr>
                    <tr>
                      <td align="left" valign="middle" class="black12">&nbsp;
                      
                      </td>
                      <td colspan="2" align="left" valign="middle" class="red">No Sub-Category Added Yet!.</td>
                    </tr>
                    <?php }?>
                    <tr>
                      <td align="left" valign="middle">&nbsp;</td>
                      <td colspan="2" align="left" valign="middle">&nbsp;</td>
                    </tr>
                  </table>
                  </form>
              </ul>
            </span>
<script type="text/javascript" language="javascript">
function catgvalid()
{
	if(document.getElementById('txtcategory').value=="")	
	{
		document.getElementById('txtcategory').style.borderColor="red";
		document.getElementById('r1').innerHTML="Required - Product Category";
		document.getElementById('txtcategory').focus();
		return false;
	}
	else
	{
		document.getElementById('txtcategory').style.borderColor="#006633";
		document.getElementById('r1').innerHTML="";
	}
	
	if(document.getElementById('txtsubcategory').value=="")	
	{
		document.getElementById('txtsubcategory').style.borderColor="red";
		document.getElementById('r1').innerHTML="Required - Sub-Category";
		document.getElementById('txtsubcategory').focus();
		return false;
	}
	else
	{
		document.getElementById('txtsubcategory').style.borderColor="#006633";
		document.getElementById('r1').innerHTML="";
	}
}
</script>            
