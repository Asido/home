<?php
session_start();
require_once("users.php");

$qid = $_POST['qid'];
$zip = $_POST['zip'];
$ans = $_POST['answers'];
$cat = $_POST['category'];

if (isset($_POST['input']) && $ans != "")
	$ans = "`answer` LIKE '%".$ans."%'";
else if ($ans != "") {
	$ans = str_replace(' ', '', $ans);
	$tokens = explode(',', $ans);
	$count = count($tokens);
	$ans = "`answer` IN (";
	for ($i = 0; $i < $count; $i++) {
		$ans .= "'".$tokens[$i]."'";
		if ($i != $count - 1)
			$ans .= ",";
	}
	$ans .= ")";
}

$answers = user::get_answers_by_id($cat, $qid, $zip, $ans);
$_SESSION['sql'] = $answers;
$ans_cnt = user::get_answer_count($cat, $qid);
$total_answers = count($answers);

echo '{';

if (isset($_POST['input'])) {
	echo '"statistic" : { "total" : "'.$total_answers.'" },';
} else {
	$stat = array(0 => 0, 1 => 0, 2 => 0, 3 => 0, 4 => 0, 5 => 0, 6 => 0, 7 => 0);
	for ($i = 0; $i < $total_answers; $i++)
		$stat[$answers[$i]['answer']]++;
	for ($i = 0; $i <= 7; $i++) {
		if ($stat[$i] != 0)
			$stat[$i] = 100 / $total_answers * $stat[$i];
	}

	echo '"statistic" : ';
	echo '{';
	for ($i = 0; $i <= 7; $i++) {
		echo '"answer'.$i.'" : "'.$stat[$i].'"';
		// if ($i != 7)
			echo ',';
	}
	echo '"total" : "'.$total_answers.'"';
	echo '},';
}

echo '"users" : [';
for ($i = 0; $i < 9; $i++) {
	echo '{ "user" : "'.$answers[$i]['username'].'",';
	echo '"answer" : "'.$answers[$i]['answer'].'" }';
	if ($i != 8)
		echo ',';
}
echo '] }';

exit;
?>
