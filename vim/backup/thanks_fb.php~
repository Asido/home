<?php
@session_start();

require_once ('includes/init.php');
require_once 'facebook/facebook.php';

if (! isset($_SESSION['listingid']))
	exit;


unset($_SESSION['orderid']);

define('FACEBOOK_APP_ID',"242311359124986");
define('FACEBOOK_SECRET',"5e0ac57badb263a89b6490e68711fe6c");

$user = null;

$facebook = new Facebook(array(
    'appId' => FACEBOOK_APP_ID,
    'secret' => FACEBOOK_SECRET,
    'cookie' => true
));

$user = $facebook->getUser(); // Get the UID of the connected user, or 0 if the Facebook user is not connected.

if(!$user || !isset($_GET['state'])) {

    /**
     * Get a Login URL for use with redirects. By default, full page redirect is
     * assumed. If you are using the generated URL with a window.open() call in
     * JavaScript, you can pass in display=popup as part of the $params.
     * 
     * The parameters:
     * - redirect_uri: the url to go to after a successful login
     * - scope: comma separated list of requested extended perms
     */

    $login_url = $facebook->getLoginUrl($params = array('scope' => "publish_stream"));
    echo ("<script> top.location.href='".$login_url."'</script>");

} else {

    try {
			$listing = Library::loadLibrary('Listings');
			$add = $listing->getListingById($_SESSION['listingid']);
            $params = array(
                'message'       =>  "New add:",
                'name'          =>  $add['title'],
                'caption'       =>  "Price: $".$add['price'],
                'description'   =>  $add['shortDescription'],
                'link'          =>  "http://bim.bb/beta1/viewlisting.php?view=".$_SESSION['listingid'],
                'picture'       =>  "http://i.imgur.com/VUBz8.png",
            );

				$post = $facebook->api("/180805425324107/feed","POST",$params);

			// unset($_SESSION['listingid']);
            /* echo "Your post was successfully posted to UID: $user"; */
        }
        catch (FacebookApiException $e) {
           // echo $e;
		   // echo $e->getCode();
        }

}
/*
try {
	$publishStream = $facebook->api("/135789409844577/feed", 'post', array(
		'message' => "....",
		'link'    => 'http://ithinkdiff.net',
		'picture' => 'http://thinkdiff.net/ithinkdiff.png',
		'name'    => 'iOS Apps & Games',
		'description'=> 'Chec......t awesome!',
		'access_token' => $params['access_token']
		)
	);
	//as $_GET['publish'] is set so remove it by redirecting user to the base url
} catch (FacebookApiException $e) {
	//echo '<script> top.location.href = "https://www.facebook.com/dialog/oauth?client_id=' . '242311359124986'.'&redirect_uri='.'http://www.bim.bb/beta1/thanks_fb.php&scope=read_stream,email,publish_stream";</script>';
	echo $e;
}*/

// unset($_SESSION['listingid']);

$class_tpl->assign('message', LANG_THANK_YOU_FB_MSG);
$class_tpl->assign('body', 'checkout/thanks.tpl');

$class_tpl->display('layout.tpl');

/* End of file thanks_fb.php */
/* Location: ./upload/thanks.php */
