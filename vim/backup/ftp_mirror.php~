<html>
<head>
	<title>Mirror update</title>
</head>

<body>
	<h1>Mirror update</h1>
	<?php
phpinfo();
	// set up login data
	$host = 'mirrors.dotsrc.org';
	$user = 'anonymous';
	$password = '';
	$remotefile = '/slackware/slackware/README.TXT';
	$localfile = '/tmp/README.TXT';

	// connect to host
	$con = ftp_connect($host);
	if (!$con) {
		echo "Error: could not connect to ftp server<br/>";
		exit;
	}
	echo "Connected to ".$host."<br/>";

	// log in to host
	$result = @ ftp_login($con, $user, $pass);
	if (!$result) {
		echo "Error: could not log on as ".$user."<br/>";
		ftp_quit($con);
		exit;
	}
	echo "Logged in as ".$user."<br/>";

	// check file times to see if an update is required
	echo "Checking file time...<br/>";
	if (file_exists($localfile)) {
		$localtime = filemtime($localfile);
		echo "Local file last updated ".date('G:i j-M-Y', $localtime)."<br/>";
	} else {
		$localtime = 0;
	}
	$remotetime = ftp_mdtm($con, $remotefile);
	if (!($remotetime >= 0)) {
		// This doesn't mean the file's not there, server may not support mod time
		echo "Can\'t access remote file time.<br/>";
		$remotetime = $localtime + 1; // make sure of an update
	} else {
		echo "Remote file last updated ".date('G:i j-M-Y', $remotetime)."<br/>";
	}
	if (!($remotetime > $localtime)) {
		echo "Local copy is up to date.<br/>";
		exit;
	}

	// download file
	echo "Getting file from server...<br/>";
	$fp = fopen($localfile, 'w');
	if (!$success = ftp_fget($con, $fp, $remotefile, FTP_BINARY)) {
		echo "Error: could not download file";
		ftp_quit($con);
		exit;
	}
	fclose($fp);
	echo "File downloaded successfully";

	// close connection to host
	ftp_quit($con);
	?>
</body>
</html>
