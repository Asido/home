<?php

	require('php/auth/auth.php');
	$logged = $auth->logged_in(true);
	if ($logged == false) 
	{
		if ($auth->cookie_log_in() == false) 
			header('Location:index.php'); 
	}
	
	$pid = $_GET['pid']; if (!isset($pid)) $pid = $_POST['pid'];
	if ( !isset($pid) || !is_numeric($pid) ) { header ('Location: dashboard.php'); exit; }
	
	$db = SCONFIG::dbconnect();
	
	$project = $db->query('SELECT p.`id`, p.`name`, p.`description`, p.`date`, p.`location`, p.`status`, p.`invited`, p.`comments`, p.`viewed`, u.`name` AS `author`, u.`id` AS `author_id` FROM `projects` p, `users` u WHERE p.`id`='.$pid.' AND p.`author`=u.`id`');
	
	
	if ($project == false) { header ('Location: dashboard.php'); exit; }
	if ($db->numRows($project) !== 1) { header ('Location: dashboard.php'); exit; }
	$project = $db->fetch($project);
	
	$viewed = "";
	if($project['viewed'] == ""){
		$viewed = $logged['id'];
	}else{
		$viewers_id = explode(",", $project['viewed']);
		if(!in_array($logged['id'], $viewers_id)){
			array_push($viewers_id, $logged['id']);
		}
		$viewed = implode(",", $viewers_id);
	}
	//print $viewed."<br>";
	$db->query("UPDATE `projects` SET viewed='".$viewed."' WHERE id='".$project['id']."'");
	
	/* POSTING A COMMENT */
	if($project['comments'] == 1){
		$error_msg = false;
		
		if ( 	isset($_POST['comment']) &&
				isset($_POST['pid']) )
			
			{
				$invited = $project['invited'];
				$invited = explode(',', $invited);
				
				// CHECKS IF USER IS INVITED TO BID
				if ( ! (
							($logged['id'] == $project['author_id']) ||
							in_array($logged['email'], $invited)
						)											
					)					
				{
					$error_msg = SMESSAGES::BID_NOT_INVITED;
				}
				else
				{
					// CHECKS IF USER IS FRIEND TO PROJECTS AUTHOR
					
					$reqf = $db->query('SELECT `id` FROM `frndrequest` WHERE `uid`='.$logged['id'].' AND `fid`='.$project['author_id']);	// FRIEND REQUEST
					$accf = $db->query('SELECT `id` FROM `frndrequest` WHERE `uid`='.$project['author_id'].' AND `fid`='.$logged['id']);	// ACCEPTED REQUEST
					
					if ( ! (
								( $db->numRows($reqf) > 0 ) &&
								( $db->numRows($accf) > 0 ) ||
								($logged['id'] == $project['author_id'])
							)
						)
							$error_msg = SMESSAGES::BID_NOT_FRIEND;
					else
					{
						//POST COMMENT
						$comment = $_POST['comment'];
						$comment = $db->format_string($comment);
						
						if (strlen($comment) >= SCONFIG::COMMENT_MIN_LENGTH )
						{
							$posted	 = $db->query('INSERT INTO `projects_comments` VALUES (NULL, '.$pid.', '.$logged['id'].', \''.$comment.'\', '.time().')');
							
							if ($posted) { header('Location: bid.php?pid='.$pid); exit; }
							
							//$error_msg = $posted ? false : mysql_error();
						}
					}
				}
			}
		
	
	
			/* GETTIN COMMENTS */
			//echo 'SELECT c.`id`, c.`text`, c.`timestamp`, u.`name` AS `author` FROM `projects_comments` c, `users` u WHERE c.`author_id`=p.`id` AND c.`project_id`='.$pid; exit;
			$comments = $db->query('SELECT c.`id`, c.`text`, c.`timestamp`, c.project_id, u.`name` AS `author`, u.`id` AS `author_id`, u.`address` AS `author_address`, u.`state` AS `author_state`, u.`email` AS `author_email`, u.`phone` AS `author_phone`, u.`business_type` AS `business_type` FROM `projects_comments` c, `users` u WHERE c.`author_id`=u.`id` AND c.`project_id`='.$pid.' ORDER BY c.`timestamp` DESC');
			$comments = $db->to_array($comments);
			$comments = STEMPLATE::to_comments_list($comments);
		}
?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Contractor Bridge</title>
<link rel="stylesheet" type="text/css" href="css/style.css"/>
<script type="text/javascript" src="js/jquery-1.3.2.js"></script>
<script type="text/javascript" src="js/mainfunc.js"></script>
<script src="pdfviewer/js/jquery.js" type="text/javascript"></script>
<script type="text/javascript" src="pdfviewer/js/jquery-1.4.3.min.js"></script>
<script type="text/javascript" src="pdfviewer/js/fancybox/jquery.easing-1.3.pack.js"></script>
<script type="text/javascript" src="pdfviewer/js/fancybox/jquery.fancybox-1.3.4.js"></script>
<script type="text/javascript" src="pdfviewer/js/fancybox/jquery.fancybox-1.3.4.pack.js"></script>
<script type="text/javascript" src="pdfviewer/js/fancybox/jquery.mousewheel-3.0.4.pack.js"></script>
<link rel="stylesheet" type="text/css" href="pdfviewer/js/fancybox/jquery.fancybox-1.3.4.css"/>
<link rel="stylesheet" type="text/css" href="pdfviewer/js/style.css"/>
<script type="text/javascript" src="script.js"></script>

<style>
#fancy-wrap
{
	width:auto !important;
}
#fancybox-content
{
	height:auto !important;
}
#fancybox-close
{
	top: 13px !important;
	right: 10px !important;
	background:url(pdfviewer/js/fancybox/fancy_close.png);
	background-repeat:	no-repeat;

	width: 10px !important;
	height: 9px !important;
}
</style>
<script>
		$(document).ready(function() {
		$("#various3").fancybox({
				'width'				: '79%',
				'height'			: '150%',
				'autoScale'			: true,
				'transitionIn'		: 'none',
				'transitionOut'		: 'none',
				'type'				: 'iframe',
				'padding' 			: 0,
				'scrolling'			:'no'
			});
		});
</script>

<script type="text/javascript" >
$(function(){
$("#lt1").click(function(){
	
	$('#login').slideToggle();
	if($('#lt1').hasClass("imgup")){

        $('#lt1').removeClass("imgup").addClass("imgdown");
		
    }
    else{

        $('#lt1').removeClass("imgdown").addClass("imgup");
    };
	});
});

</script>
<script>
$(document).ready( function() {
	$("#post_topbar tr td").mouseover( function() { 
							$(this).addClass("post_topbarh") 
								})
							.mouseout( function() { 
							$(this).removeClass("post_topbarh")
								})
								
	$('#post-comment').submit( function ()
	{
		var text = $('#bid-tarea').val();
		
		return text.length >= <? echo SCONFIG::COMMENT_MIN_LENGTH; ?> ;
	});
	
	$("#send-button").click ( function ()
	{
		$('#post-comment').submit();
	});
	
	var content_bid = $('#content-bid');
	var comments	= $('#bid-comments');
	
	content_bid.css('min-height', parseInt(content_bid.css('min-height')) + comments.height() -100 + 'px');
});
</script>

<script type="text/javascript">

$(document).ready ( function ()
{
	var pbias	= $('#profile-bias');
	var x		= ( $(window).width()	 - pbias.width() ) * 0.5;
	var y		= ( $(window).height() - pbias.height()) * 0.5;
	
	pbias.css( { left : x + "px", top : y + "px" } );
	
	$('.profbio-close').click( function ()
	{
		$('#profile-bias').hide();
	});
	
});

function showBias ( author, avatar, address, state, email, phone, business_type )
{
	var pbias	= $('#profile-bias');
	
	pbias.find(".profile-bias-username").text ( author );
	pbias.find("#profile-bias-avatar")	.attr ( 'src', avatar );
	pbias.find("#profile-bias-address")	.text ( address );
	pbias.find("#profile-bias-state")	.text ( state );
	pbias.find("#profile-bias-email")	.text ( email );
	pbias.find("#profile-bias-phone")	.text ( phone );
	pbias.find("#profile-bias-business-type").text( business_type );
	
	pbias.show ();
}

</script>

<style type="text/css">
.job {
	font-family: Verdana, Geneva, sans-serif;
	font-size: 12px;
	font-weight: bold;
}
</style>
</head>

<body>

<div id="profile-bias" class="profbio">
	<div class="profbio-header">
    	<span class="profbio-title profile-bias-username"></span>
        <span class="profbio-close">X</span>
    </div>
    <div class="profbio-footer">
    	<div class="profbio-left">
        	<img id="profile-bias-avatar" src="" /><br />
            <span class="profile-bias-username"></span>
        </div>
        <div class="profbio-right">
        	<p><span class="profbio-label">Address : </span><span id="profile-bias-address"></span></p>
            <p><span class="profbio-label">State : </span><span id="profile-bias-state"></span></p>
            <p><span class="profbio-label">Email : </span><span id="profile-bias-email"></span></p>
            <p><span class="profbio-label">Phone : </span><span id="profile-bias-phone"></span></p>
            <p><span class="profbio-label">Type of Business : </span><span id="profile-bias-business-type"></span></p>
        </div>
    </div>
</div>

<div id="topbar"> </div> 
    
<div id="header-inner"> 
	<?php include('topbar.php'); ?>
</div> <!--header-inner-->

<div id="post_topbar"> 
	<table>
		<tr>
           	<td><a href="dashboard.php"><div> Home </div></a></td>
            <td><a href="myprofile.php"><div> My Profile </div></a></td>
            <td><a href="postjob.php"><div> Post A Job </div></a></td>
            <td><a href="vcon.php"><div> View Contractors </div></a></td>
            <td><a href="refer.php"><div> Refer A Friend </div></a></td>
            <td id="topbar_tdfix"><a href="support.php"><div> Support </div></a></td>
        </tr>
    </table>
</div>


<div id="content-bid">
	<div id="content-inner"></div><!--content-inner-->
   
    <div id="bid-wrap">
    	<div id="bid-title">
        	<div id="bid-titleright">
            	<p><span id="bid-h1"><?php echo $project['name']; ?></span></p><br />
                <p><span id="bid-h2"><?php echo $project['author']; ?></span><span id="bid-h3"> has created this Job Listing.</span></p><br />
            </div>            
        </div><!--bid-title-->
        
        <div id="bid-main">
            <div id="bid-r1" class="bid-rows">
                <div class="bid-lefts">When : </div>
                <div class="bid-rights"><?php 
											$date = SCONFIG::get_date_of($project['date']); 
											echo $date;	
				?></div>
            </div>
            <div id="bid-r2" class="bid-rows">
                <div class="bid-lefts">Where : </div>
                <div class="bid-rights"><?php echo $project['location']; ?></div>
            </div>
            <div id="bid-r3" class="bid-rows">
                <div class="bid-lefts">Job Description : </div>
                <div class="bid-rights"><?php echo $project['description']; ?>
                </div>
            </div>
            <div id="bid-r4" class="bid-rows">
                <div class="bid-lefts">Attachment : </div>
                <div class="bid-rights"><div id="bid-attachbutton"><a id="various3" href="pdfviewer/pdfviewer.php?pid=<? echo $pid; ?>">View Attachments</a></div></div>
            </div>
            <?php
				if($project['comments'] == 1) {
			?>
            <div id="bid-r6" class="bid-rows">
                <div class="bid-lefts">Comment : </div>
                <div class="bid-rights">
                	<form id="post-comment" method="post" action="bid.php">
                    	<input type="hidden" name="pid" value="<?php echo $pid; ?>"  />
                		<textarea id="bid-tarea" name="comment"></textarea>
                    </form>
                </div>
            </div>
            <div id="bid-r7" class="bid-rows">
                <div class="bid-rights">
                    <div id="send-button" style="cursor:default"><a>Send</a></div>
                </div>
            </div>
            <div id="regnotif" class="regnotif-error" style="float:right; width:520px; display:<?php echo $error_msg ? 'block' : 'none'; ?>;"><div id="regnotif-err-wrap" style="text-align:center"><p style="margin:0 auto; font-size:13px; font-weight:bold; text-align:center; width:300px;"><?php echo $error_msg; ?></p></div></div>
           	<div id="bid-comments" class="bid-rows">
            	<?php echo $comments; ?>
            </div>
            <?php } ?>
        </div><!--bid-main-->
    
    </div> <!--bid-wrap-->
</div><!--content-bid-->

<div id="footer" style="margin-top:-322px;">
	<div id="topbar" style="height:10px;"></div>
    <div id="footer-inner">
		<div id="aboutus">	
        	<span id="aboutushead">About US</span>
			<p>
				Created by contractors for contractors, Contractor Bridge was developed out of a need for efficiency in the transfer of 
                construction documents.After dealing with the annoyances and frustrations of too many FTP
                uploads/downloads, we thought, "There must be a better way." 
                </p>
                <p>
                With inspirations from social networking sites and the increasingly 
                popular use of "Cloud Computing," Contractor Bridge has been developed to help
                contractors create a network of the contractors they work with and
                share files easily and seamlessly with all of them, all on a secure "cloud"
                based server. 
                </p>
                <p>
                No more bogging down of your server to upload FTP's and
                no more confusion/headaches associated with this outdated process. Simply
                upload drawings/files, and invite contractors to have access to these
                files. Simple, easy and straightforward.
        		</p>
        </div> <!-- aboutus -->
		
        <div id="stat">
			<p>8597 Users Online Now</p>
            <p> Corporate Twitter <img src="images/twitter.jpg" /></p>
            <p> Jobs on Twitter <img src="images/twitter.jpg" /></p>
            <p>Read Our Blog <img src="images/blogicon.jpg" /></p>
            <p>Facebook <img src="images/fbicon.jpg" /></p>
            <p>Jobs via RSS <img src="images/blogicon.jpg" /></p>
		</div> <!-- stat -->
        
        <div id="logobottom" ></div>
		<div id="footertext">FAQ / Affiliates / Upcoming Events / Press Releases / In The News / Quotes / Top Users / Careers / Terms /Privacy Policy  &nbsp; &nbsp;© 2006–2011, Contractor Bridge
		</div> <!-- footertext -->

	</div> <!-- footer-inner -->
</div> <!-- footer -->
</body>
</html>
