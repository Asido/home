<?php
require_once ('facebook.php');// this line calls our facebook.php file that is the core of PHP facebook API

session_start();
//session_destroy();
require_once('php/auth.php');
require_once('php/config.php');
require_once('php/database.php');
// Create our Application instance.
$facebook = new Facebook(array(
  'appId' => '129819747094801',
  'secret' => 'c45817586a68e1fb1d093bf5fb0374bc',
  'cookie' => true,
)); // all we are doing is creating an array for facebook to use with our app id and app secret in and setting the cookie to true
try {
  $me = $facebook->api('/me');
} catch (FacebookApiException $e) {
  error_log($e);
} // this code is saying if the session to the app is created use the $me as a selector for the information or die


if (isset($_POST['name']) && isset($_POST['email']) && isset($_POST['prof_pic']) && isset($_POST['bday']) && isset($_POST['location']) && isset($_POST['password']) && isset($_POST['cpassword'])) {
	$db = database::get_instance();
	$name = $db->format_string($_POST['name']);
	$mail = $db->format_string($_POST['email']);
	$pic = $db->format_string($_POST['prof_pic']);
	$bday = $db->format_string($_POST['bday']);
	$location = $db->format_string($_POST['location']);
	$psw = $db->format_string($_POST['password']);
	$re_psw = $db->format_string($_POST['cpassword']);
	
	if (!$db->free_field('email', $mail))
{
	$_SESSION['values']=mysql_real_escape_string($_POST);
		$error_msg = CONFIG::SIGNUP_EMAIL_IN_USE;

}
	else {
		$ok = $auth->signup($name, $mail, $pic, $bday, $location, $psw, sha1(microtime()));
		$error_msg = ($ok ? CONFIG::SIGNUP_SUCCESSFUL : CONFIG::SIGNUP_ERROR);
		if($msg=CONFIG::SIGNUP_SUCCESSFUL)
		{
			header('location: login.php?m=Sign up successful. Check your email.');
			
		}
		else
		{
		$ferror_msg=CONFIG::SIGNUP_ERROR;
		}
	}
}
// facebook signup
if (isset($_POST['fname']) && isset($_POST['fmail']) && isset($_POST['fprof_pic']) && isset($_POST['fbday']) && isset($_POST['flocation']) && isset($_POST['fpassword']) && isset($_POST['fcpassword'])) {
	
	$db = database::get_instance();
	$name = $db->format_string($_POST['fname']);
	$mail = $db->format_string($_POST['fmail']);
	$pic = $db->format_string($_POST['fprof_pic']);
	$bday = $db->format_string($_POST['fbday']);
	$location = $db->format_string($_POST['flocation']);
	$psw = $db->format_string($_POST['fpassword']);
	$re_psw = $db->format_string($_POST['fcpassword']);
	if (!$db->free_field('email', $mail))
{
//	$_SESSION['values']=$_POST;
		$ferror_msg = CONFIG::SIGNUP_EMAIL_IN_USE;

}
	else {
		$ok = $auth->signup($name, $mail, $pic, $bday, $location, $psw, sha1(microtime()));
		$msg = ($ok ? CONFIG::SIGNUP_SUCCESSFUL : CONFIG::SIGNUP_ERROR);
		if($msg=CONFIG::SIGNUP_SUCCESSFUL)
		{
			header('location: login.php?m=Sign up successful. Check your email.');
			
		}
		else
		{
		$ferror_msg=CONFIG::SIGNUP_ERROR;
		}
		
	}
}
?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>YouTours</title>
<link rel="stylesheet" href="http://jqueryui.com/themes/base/jquery.ui.all.css">
<link href="css/style.css" rel="stylesheet" type="text/css" />

<script type="text/javascript" src="js/jquery.js"></script>
<script type="text/javascript" src="js/validation.js"></script>
<script type="text/javascript" src="js/submit.js"></script>
<script type="text/javascript" src="js/all.js"></script>
<script type="text/javascript" src="js/script.js"></script> 
	<script src="http://jqueryui.com/jquery-1.5.1.js"></script> 
	<script src="http://jqueryui.com/ui/jquery.ui.core.js"></script> 
	<script src="http://jqueryui.com/ui/jquery.ui.widget.js"></script> 
	<script src="js/jquery.ui.datepicker.js"></script> 
<script type="text/javascript" src="js/ajaxupload.3.5.js" ></script>
<script type="text/javascript" >
	$(function(){
		if($('#err').html()==null)
			{
			}
	else
	{
	mov();
	}
	if($('#errr').html()==null)
	{
	}
	else
	{
	fbmov();
	}
	
	if($('#fname').val()=="")
	{
	}
	else
	{
	fbmov();
	}
	
	$( "#datepicker" ).datepicker({
			changeMonth: true,
			changeYear: true
		});
		});
		</script>
        <script type="text/javascript" >
	$(function(){
		var btnUpload=$('#upload');
		var status=$('#errordiv');
		new AjaxUpload(btnUpload, {
			action: 'upload.php',
			name: 'uploadfile',
			onSubmit: function(file, ext){
				 if (! (ext && /^(jpg|png|jpeg|gif)$/.test(ext))){ 
                    // extension is not allowed 
					status.text('Only JPG, PNG or GIF files are allowed');
					return false;
				}
				status.text('Uploading...');
			},
			onComplete: function(file, response){
				//On completion clear the status
				status.text('');
			//	document.location.reload();
				//Add uploaded file to list
				if(response.length > 0){
					$('#profile-img').html('<img src="uploads/'+response+'.jpg" width="50" height="50"/>').addClass('success');
					$('#prof_pic').val(response);
				} else{
					//$('<div></div>').appendTo('#profile-img').text(file).addClass('error');
				}
			}
		});
		});
function mov()
{
	$('#m2').animate({
    top: '-450px',
  }, 1000, function() {
    // Animation complete.
  });
  $('#m1').animate({
    top: '-450px',
  }, 1000, function() {
    // Animation complete.
  });
}
function fbmov()
{
	$('#m3').animate({
    top: '-905px',
  }, 1000, function() {
    // Animation complete.
  });
  $('#m1').animate({
    top: '-450px',
  }, 1000, function() {
    // Animation complete.
  });
 
}
function piccheck()
	{
		if(document.getElementById('prof_pic').value=="")
		{
	$('#profile-img').css( 'border', 'red 1px solid');
	
		}
	}
</script>
</head>
<body>
<div class="content">
<?php include("header.php");
include("menu.php");?>
    <div class="cont">
		<div class="nabod">
            	<div class="left-sign">
                	<div class="signtab">SIGNUP
                    </div>
                    <div class="signbg">
                    <div id="slid">
                    <div id="m1">
                   <h3> Facebook Login</h3>
                   <h5>
                    Already have a Facebook.com account? Login using the button below to link to you account and fill in the information automatically.</h5>
                    
                    <div  class="face">
                    <fb:login-button autologoutlink="true" perms="email,user_checkins,user_location,publish_stream,user_birthday,offline_access"> Connect with facebook</fb:login-button><div id="fb-root"></div>
                     <script src="http://connect.facebook.net/en_US/all.js"></script>
      <script>
	  
         FB.init({ 
            appId:'129819747094801', cookie:true, 
            status:true, xfbml:true 
         });
		 FB.Event.subscribe('auth.login', function(response) {
 	 window.location.reload(); //will reload your page you are on
		
		//window.location.reload();
      });
      </script> 
                    </div>
                   
                    
                <h3 style="padding-left:176px;padding-top:54px;padding-bottom:23px; color:#747575;">  OR</h3>
                   <h3> Manually Create Account</h3>
                   <h5> Create an account by filling the information manually.</h5>
                   <div id="cre" class="creacctab" onClick="mov();">Manually Create Account
                    </div>
                    </div><!--m1-->
                    
                    
                      <div id="m2">
                      <form id="signup-form" method="post" action="signup.php">
                   <h3 class="fbfb"> Manual Sign Up</h3>
                   <div class="row" style="padding-top: 0px !important;">
                	<span class="q-lab">Actual Name :</span>
                	<span class="nam"><input type="text" id="name" name="name" class="q-input required" value="<?php if(isset($_SESSION['values']) ){echo $_SESSION['values']['name']; }else{} ?>" /><br/></span>
                    <div style="font-size:10px;">(First and Lastname)</div>
                   </div>
                    <div class="row">
                	<span class="q-lab">E mail : </span>
                	<span class="mai"><input type="text" id="email" name="email" class="q-input required email"  /><br/></span>
                   </div>
                  <div class="row">
                	<span class="q-lab">Profile Picture : </span>
                    <div id="profile-pic">
                    	<div id="profile-img" ></div>
                        <div id="upload"></div>
                    </div>
                    <div id="errordiv"></div>
                </div>
                     <div class="row">
                	<span class="q-lab">Birthday : </span>
                	<span class="bda"><input type="text" id="datepicker" name="bday" class="q-input required" value="<?php if(isset($_SESSION['values']) ){echo $_SESSION['values']['bday']; }else{} ?>" /><br/></span>
                   </div>
                     <div class="row">
                	<span class="q-lab">Location : </span>
                	<span class="lo"><input type="text" id="location" name="location" class="q-input required" value="<?php if(isset($_SESSION['values']) ){echo $_SESSION['values']['location']; }else{} ?>" /><br/></span>
                   </div>
                    <div class="row">
                	<span class="q-lab">Password : </span>
                	<span class="pas"><input type="password" id="password" name="password" class="q-input required fpassword" /><br/></span>
                   </div>
                    <div class="row">
                	<span class="q-lab">Confirm Password : </span>
                	<span class="cpas"><input type="password" id="cpassword" name="cpassword" class="q-input required fpassword" /><br/></span>
                   </div>
                    <div class="row">
                    <?php
					if (isset($error_msg))
						echo '<div id="err" >'.$error_msg.'</div>';
				?>
          
                	<div id="sign-button" onClick="piccheck();">
                    </div>
                   </div>
                <input type="hidden" name="prof_pic" id="prof_pic" class="required" /> 
                    </form>
                    </div><!--m2-->
                   
                    
                    <div id="m3" ><!--m3-->
   
<form name="fbsignup" id="fbsignup" action="signup.php" method="post">
                   <h3 class="fbfb"> Facebook Sign Up</h3>
                   <div class="row" style="padding-top: 0px !important;">
                	<span class="q-lab">Actual Name :</span>
                	<span class="nam"><input type="text" id="fname" name="fname" class="q-input required" readonly	 value="<? if ($facebook->getSession()) {echo $me['first_name'].$me['last_name'];}?>"  /><br/></span>
                    <div style="font-size:10px;">(First and Lastname)</div>
                   </div>
                    <div class="row">
                	<span class="q-lab">E mail : </span>
                	<span class="mai"><input type="text" id="fmail" name="fmail" class="q-input required" readonly value="<? if ($facebook->getSession()) {echo $me['email'];} ?>"  /><br/></span>
                   </div>
                  <div class="row">
                	<span class="q-lab">Profile Picture : </span>
                    <div id="profile-pic">
                    	<div id="profile-img" ><img src="http://graph.facebook.com/<?php echo $me['id']; ?>/picture"></div>
                    </div>
                </div>
                     <div class="row">
                	<span class="q-lab">Birthday : </span>
                	<span class="bda"><input type="text" id="fbday" name="fbday" class="q-input required" readonly value="<? if ($facebook->getSession()) {echo $me['birthday'];} ?>"  /><br/></span>
                   </div>
                     <div class="row">
                	<span class="q-lab">Location : </span>
                	<span class="lo"><input type="text" id="flocation" name="flocation"  class="q-input required" value="<? if ($facebook->getSession()) {echo $me['location']['name'];} ?>"/><br/></span>
                   </div>
                    <div class="row">
                	<span class="q-lab">Password : </span>
                	<span class="pas"><input type="password" id="fpassword" name="fpassword" class="q-input required password"  /><br/></span>
               
                   </div>
                    <div class="row">
                	<span class="q-lab">Confirm Password : </span>
                	<span class="cpas"><input type="password" id="fcpassword" name="fcpassword" class="q-input required password"  /><br/></span>
                   </div>
                    <div class="row">
                     <?php
					
					if (isset($ferror_msg))
						echo '<div id="errr" >'.$ferror_msg.'</div>';
				?>
                   
                	<div id="signupdo">
                    </div>
                   </div>
                   <input type="hidden" name="fprof_pic" id="fprof_pic" value="http://graph.facebook.com/<?php echo $me['id']; ?>/picture" />
                   </form>
               
                    </div><!--m3-->
                    
                    
                    </div><!--slide-->
                    
                    
                    </div>
               
                </div>
                <div class="shado">
                    </div>
                
               <div class="mid-sign">
                </div>
                <div class="right-sign">
                <div class="adsign" >
        			<h4>Why Join?</h4>
         		 </div>
          		<div class="signtext">
         Lorem ipsum dolor sit amet, consectetur adipisicing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation .ed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud sed do eiusmod tempor incididunt ut labore et dolore magna aliminim veniam, quis nostrudsed do eiusmod tempor incididunt ut labore et dolore magna aliqua. 
				</div>
               
                
                <div class="utub">
                </div>
                
                </div>
 
 
 			</div>
 	</div>
 
 
   <?php include("footer.php"); session_destroy(); ?>
    
    
</div>
</body>
</html>
