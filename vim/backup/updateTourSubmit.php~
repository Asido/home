<?php

session_start();

require_once('php/database.php');

function mysql_querp($query)

{

	// echo $query."<br><br>";

	$db = database::get_instance();
	$result = $db->query($query);
	// echo $result;
	// echo mysql_error();
	return $result;

}

require_once("funcsv.php");

connect();

//echo "<pre>";


//print_r($_POST);




$user_id =$_SESSION['user_id'];

$videotype=mysql_real_escape_string($_POST['videotype']);

$location = mysql_real_escape_string($_POST['location']);

$tour_id=mysql_real_escape_string($_POST['tour_id']); 

$maptype=mysql_real_escape_string($_POST['maptype']);

$svmapurl = mysql_real_escape_string($_POST['sv_mapurl']);

$vtype = mysql_real_escape_string($_POST['videotype']);

$title =mysql_real_escape_string($_POST['title']) ;

$description=mysql_real_escape_string($_POST['description']) ;

$tags=mysql_real_escape_string($_POST['tags']);

$categoryid=mysql_real_escape_string($_POST['category']);

$language=mysql_real_escape_string($_POST['language']) ;

$location=mysql_real_escape_string($_POST['location']) ;

$countryid=mysql_real_escape_string($_POST['country']) ;

$linaudio=mysql_real_escape_string($_POST['linaudio']) ;

$linvideo=mysql_real_escape_string($_POST['linvideo']) ;

$tourstatus=mysql_real_escape_string($_POST['tourstatus']) ;

$price=mysql_real_escape_string($_POST['price']) ;

$images = $_SESSION['images'];

if(isset($_POST['cart1']))
{
	if($_POST['cart1']!="")
	{
		$cart1 = "on";

	}
}
if(isset($_POST['cart2']))
{
	if($_POST['cart2']!="")
	{
		$cart2 = "on";

	}
}

// tour to edit
$tour = mysql_querp("SELECT * FROM `tour_details` WHERE `tour_id`=".$tour_id);
if (mysql_num_rows($tour) != 1) {
	header("Location: index.php");
	exit;
}
$tour = mysql_fetch_array($tour);


// edit city
$r = mysql_querp("SELECT * from city where city_name='".$location."'");
if(mysql_num_rows($r)>0) {
	$onerow= mysql_fetch_array($r);
	$city_id = $onerow['city_id'];
} else {
	$r = mysql_querp("INSERT into city values('',".$countryid.",'".$location."')");
	$city_id = mysql_insert_id();
	//echo "city not found inserted<br />";
}
if ($tour['city_id'] != $city_id)
	mysql_querp("UPDATE `tour_details` SET `city_id`=".$city_id." WHERE `tour_id`=".$tour_id);

// edit map
$sql = mysql_querp("SELECT * FROM `maps` WHERE `map_id`=".$tour['map_id']);
$sql = mysql_fetch_array($sql);
if ($sql['link'] != $svmapurl) {
	if($maptype=="google")

	{

		$svmapurl.="&amp;output=embed";

	}

	//setting map_id

	$r = mysql_querp("INSERT INTO maps (map_type, link, status) VALUES ('".$maptype."', '".$svmapurl."', 1)");

	$map_id = mysql_insert_id();
	mysql_querp("UPDATE `tour_details` SET `map_id`=".$map_id." WHERE `tour_id`=".$tour_id);
}

//echo "</br>Got map id :".$map_id;



//setting album_id

$len = count($images);

for($imagenum=0;$imagenum<$len;$imagenum++)
{
	$picpath = $images[$imagenum]['path'];
	$r = mysql_querp("INSERT INTO album (album_id ,pic_path)VALUES (".$tour_id.",'".$picpath."')");
}
//echo "</br>Got album count:".$len;
//setting video

for ($len = 0;; $len++) {
	if (!isset($_POST['video'.$len]))
		break;
}
//$len = count($videos);

// echo "<b>no.of videos</b>=".$len;

if($len>0)

{

	if($len==1)

	{

		$mainvideo = $_POST['video0'];//$videos[1]['tmpname'];

		$intro="";

	}

	else

	{

		$mainvideo = $_POST['video0'];//$videos[1]['tmpname'];

		$intro=	$_POST['video1'];//$videos[2]['tmpname'];

	}
	$vid = mysql_fetch_array(mysql_query("SELECT `tour_path` FROM `videos` WHERE `video_id`=".$tour['video_id']));
	if ($vid['tour_path'] != "")
		unlink("uploads/".$vid['tour_path']);
	$r =mysql_querp("INSERT INTO videos VALUES ('', '".$videotype."', '".$mainvideo."', '".$intro."', '".$linvideo."')");
	$video_id = mysql_insert_id();
	mysql_querp("UPDATE `tour_details` SET `video_id`=".$video_id." WHERE `tour_id`=".$tour_id);
}	


// edit audio
for ($len = 0;; $len++) {
	if (isset($_POST['audio'.$len]))
		mysql_querp("INSERT INTO `audio` (`path`,`tour_id`) VALUES ('".$_POST['audio'.$len]."',".$tour_id.")");
	else
		break;
}


//echo "</br>Got video id :".$video_id;

//setting cart

if($cart1=="on")

{

	$featured=2;

}

else

{

	$featured=0;

}

if($cart2=="on")

{

	$etravels=2;

}

else

{

	$etravels=0;

}



//echo "</br>Got cart:".$featured.$etravels;

//to tour_details

//

$status=1;

if($tourstatus=='save')

{

	$status=1;

	

}

else if($tourstatus=='submit')

{

	$status=2;

}

if ($description != $tour['description'])
	mysql_querp("UPDATE `tour_details` SET `description`='".$description."' WHERE `tour_id`=".$tour_id);
if ($title != $tour['title'])
	mysql_querp("UPDATE `tour_details` SET `title`='".$title."' WHERE `tour_id`=".$tour_id);
if ($tags != $tour['tags'])
	mysql_querp("UPDATE `tour_details` SET `tags`='".$tags."' WHERE `tour_id`=".$tour_id);
if ($categoryid != $tour['category_id'])
	mysql_querp("UPDATE `tour_details` SET `category_id`='".$categoryid."' WHERE `tour_id`=".$tour_id);
if ($language != $tour['language_id'])
	mysql_querp("UPDATE `tour_details` SET `language_id`='".$language."' WHERE `tour_id`=".$tour_id);
if ($linaudio != $tour['audio_length'])
	mysql_querp("UPDATE `tour_details` SET `audio_length`='".$linaudio."' WHERE `tour_id`=".$tour_id);
if ($linvideo != $tour['lw_length'])
	mysql_querp("UPDATE `tour_details` SET `lw_length`='".$livideo."' WHERE `tour_id`=".$tour_id);
if ($price != $tour['price'])
	mysql_querp("UPDATE `tour_details` SET `price`='".$price."' WHERE `tour_id`=".$tour_id);
if ($featured != $tour['featured'])
	mysql_querp("UPDATE `tour_details` SET `featured`='".$featured."' WHERE `tour_id`=".$tour_id);
if ($etravels != $tour['etravels'])
	mysql_querp("UPDATE `tour_details` SET `etravels`='".$etravels."' WHERE `tour_id`=".$tour_id);
if ($status != $tour['status'])
	mysql_querp("UPDATE `tour_details` SET `status`='".$status."' WHERE `tour_id`=".$tour_id);

/* $query ="UPDATE  tour_details  SET  title='".$title."' ,  description='".$description."' ,  tags='".$tags."' ,  category_id='".$categoryid."' ,  language_id='".$language."' ,  city_id='".$city_id."' ,  audio_length='".$linaudio."' ,  lw_length='".$linvideo."' ,  price='".$price."' ,  featured=".$featured." ,  etravels=".$etravels." ,  map_id=".$map_id." ,  album_id=".$tour_id.",  video_id=".$video_id." ,  status=".$status." ,  user_id=".$user_id." WHERE tour_id=".$tour_id; */

// mysql_querp($query); 

//echo $query;

unset($_SESSION['images']);

unset($_SESSION['uploadcount']);

unset($_SESSION['googleurl']);

unset($_SESSION['googlelink']);

unset($_SESSION['videos']);

function addToCart($tour_id,$etravels=false,$featured=false)

{

	if(isset($_SESSION['cart']))

	{

		$count = count($_SESSION['cart']);

		$_SESSION['cart'][$count]['tour_id'] = $tour_id;

		$_SESSION['cart'][$count]['etravels'] = ($etravels==true)?true:false;

		$_SESSION['cart'][$count]['featured'] = ($featured==true)?true:false;

	}

	else

	{

		$_SESSION['cart'][0]['tour_id'] =  $tour_id;

		$_SESSION['cart'][0]['etravels'] = ($etravels==true)?true:false;

		$_SESSION['cart'][0]['featured'] = ($featured==true)?true:false;

	}

}

if($featured==2 && $etravels==2)

{

	addToCart($tour_id,true,true);

	header("location:mycart.php");

	

}

else if($featured==2 && $etravels==0)

{

	addToCart($tour_id,true,false);

	header("location:mycart.php");

}

else if($featured==0 && $etravels==2)

{

	addToCart($tour_id,false,true);

	header("location:mycart.php");

}

else if($featured==0 && $etravels==0)

{

	addToCart($tour_id,false,false);

	header("location:uploadtours.php?success&id".$tour_id);

}

//

?>
