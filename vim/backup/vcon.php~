<?php
session_start();
if(!session_is_registered(user_id)){
header("location:index.php");
//exit();
}
$uid=$_SESSION['user_id'];
require_once 'connectdb.php';
require_once 'php/config.php';
connectdb();

?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>Contractor Bridge</title>
<link rel="stylesheet" type="text/css" href="css/style.css"/>
<script src="js/jquery.js" type="text/javascript"></script>

<script>
$(function(){
$("#lt1").click(function(){
	
	$('#login').slideToggle();
	if($('#lt1').hasClass("imgup")){

        $('#lt1').removeClass("imgup").addClass("imgdown");
		
    }
    else{

        $('#lt1').removeClass("imgdown").addClass("imgup");
    };
	});
});

</script>
<script>
$(document).ready( function() {
	$("#post_topbar tr td").mouseover( function() { 
							$(this).addClass("post_topbarh") 
								})
							.mouseout( function() { 
							$(this).removeClass("post_topbarh")
								})
});
</script>
<script type="text/javascript">
function loadXMLDoc()
{
	val = document.getElementById("input-search").value;

	var xmlhttp;
	if (window.XMLHttpRequest)
	  {// code for IE7+, Firefox, Chrome, Opera, Safari
	  xmlhttp=new XMLHttpRequest();
	  }
	else
	  {// code for IE6, IE5
	  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
	  }
	xmlhttp.onreadystatechange=function()
	  {
	  if (xmlhttp.readyState==4 && xmlhttp.status==200)
		{
		document.getElementById("vc-contracts").innerHTML=xmlhttp.responseText;
		}
	  }
	xmlhttp.open("GET","searchresults.php?search="+val,true);
	xmlhttp.send();
}
</script>
<script type="text/javascript">
function friendrequest(cuid)
{
	//cuid = document.getElementById("cuid").value;
	var xmlhttp;
if (window.XMLHttpRequest)
  {// code for IE7+, Firefox, Chrome, Opera, Safari
  xmlhttp=new XMLHttpRequest();
  }
else
  {// code for IE6, IE5
  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
xmlhttp.onreadystatechange=function()
  {
  if (xmlhttp.readyState==4 && xmlhttp.status==200)
    {
    document.getElementById("frequest"+cuid).innerHTML=xmlhttp.responseText;
    }
  }
xmlhttp.open("GET","sendrequest.php?cuid="+cuid,true);
xmlhttp.send();
}
</script>
<script type="text/javascript">
function acceptrequest(cuid)
{
	//cuid = document.getElementById("cuid").value;
	var xmlhttp;
if (window.XMLHttpRequest)
  {// code for IE7+, Firefox, Chrome, Opera, Safari
  xmlhttp=new XMLHttpRequest();
  }
else
  {// code for IE6, IE5
  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
xmlhttp.onreadystatechange=function()
  {
  if (xmlhttp.readyState==4 && xmlhttp.status==200)
    {
    document.getElementById("frequest"+cuid).innerHTML=xmlhttp.responseText;
    }
  }
xmlhttp.open("GET","acceptrequest.php?ajax=1&cuid="+cuid,true);
xmlhttp.send();
}
</script>
<script type="text/javascript">
function sendmsg(cuid)
{
	//cuid = document.getElementById("cuid").value;
	/*var subject=document.forms["compose_msg"]["subject"].value;
	var message=document.forms["compose_msg"]["message"].value;*/
	subject = document.getElementById("subject"+cuid).value;
	message = document.getElementById("message"+cuid).value;
	var xmlhttp;
if (window.XMLHttpRequest)
  {// code for IE7+, Firefox, Chrome, Opera, Safari
  xmlhttp=new XMLHttpRequest();
  }
else
  {// code for IE6, IE5
  xmlhttp=new ActiveXObject("Microsoft.XMLHTTP");
  }
xmlhttp.onreadystatechange=function()
  {
  if (xmlhttp.readyState==4 && xmlhttp.status==200)
    {
    document.getElementById("ml"+cuid).innerHTML=xmlhttp.responseText;
    }
  }
xmlhttp.open("GET","sendmsg.php?cuid="+cuid+"&&subject="+subject+"&&message="+message,true);
xmlhttp.send();
$('#mydiv'+cuid).hide();
//alert(message);
//alert(subject);
}
</script>
<script type="text/javascript">
function compose(cuid)
{
	$('#mydiv'+cuid).css("height","100%");
	$('#mydiv'+cuid).css("width","880px");
	
	
	$('#mydiv'+cuid).css("position","fixed");
	$('#mydiv'+cuid).css("top","30%");
	$('#mydiv'+cuid).css("left","30%");
	$('#mydiv'+cuid).css("z-index","1001");
	$('#mydiv'+cuid).show();
	
}
</script>
<script type="text/javascript">
function closebox(cuid)
{
	$('#mydiv'+cuid).hide();
}
</script>

<script type="text/javascript">

$(document).ready ( function ()
{
	var pbias	= $('#profile-bias');
	var x		= ( $(window).width()	 - pbias.width() ) * 0.5;
	var y		= ( $(window).height() - pbias.height()) * 0.5;
	
	pbias.css( { left : x + "px", top : y + "px" } );
	
	$('.profbio-close').click( function ()
	{
		$('#profile-bias').hide();
	});
	
});

function showBias ( author, avatar, address, state, email, phone, business_type )
{
	var pbias	= $('#profile-bias');
	
	pbias.find(".profile-bias-username").text ( author );
	pbias.find("#profile-bias-avatar")	.attr ( 'src', avatar );
	pbias.find("#profile-bias-address")	.text ( address );
	pbias.find("#profile-bias-state")	.text ( state );
	pbias.find("#profile-bias-email")	.text ( email );
	pbias.find("#profile-bias-phone")	.text ( phone );
	pbias.find("#profile-bias-business-type").text( business_type );
	
	pbias.show ();
}

function delete_contractor(uid, fid)
{
	if (confirm("This option will delete the contractor from your contractor list.\nPress OK to continue.")) {
		var data = "uid="+uid+"&fid="+fid;
		$.ajax({
			url: "php/ajax/del_contractors.php",
			type: "POST",
			//dataType: 'json',
			data: data,
			cache: false,
			/*success: function ( r )
			{
				alert( r );
				alert("Error deleting the contractor. Try again later");
			},*/
			success: function(ret) {
				window.location = "vcon.php";
			}
		});
	}
}

</script>

<style type="text/css">
.job {
	font-family: Verdana, Geneva, sans-serif;
	font-size: 12px;
	font-weight: bold;
}
#s-button
{
	margin-right: 40px;
    padding-right: 0;
	cursor: pointer;
}
</style>

<style>

#vc-contracts {

    height: 100%;

}

</style>

<style>

.mail_compose

{

	background:url(images/compose_bg.gif);

	height:214px;

	width:541px;

}

.compose_send_btn

{

	background:url(images/compose_send.gif) no-repeat;

	width:71px;

	height:26px;

	border:none;

}

.compose_cancel_btn

{

	background:url(images/compose_cancel.gif) no-repeat;

	width:71px;

	height:26px;

	border:none;

}

</style>
</head>

<body>

<div id="profile-bias" class="profbio">
	<div class="profbio-header">
    	<span class="profbio-title profile-bias-username"></span>
        <span class="profbio-close">X</span>
    </div>
    <div class="profbio-footer">
    	<div class="profbio-left">
        	<img id="profile-bias-avatar" src="" /><br />
            <span class="profile-bias-username"></span>
        </div>
        <div class="profbio-right">
        	<p><span class="profbio-label">Address : </span><span id="profile-bias-address"></span></p>
            <p><span class="profbio-label">State : </span><span id="profile-bias-state"></span></p>
            <p><span class="profbio-label">Email : </span><span id="profile-bias-email"></span></p>
            <p><span class="profbio-label">Phone : </span><span id="profile-bias-phone"></span></p>
            <p><span class="profbio-label">Type of Business : </span><span id="profile-bias-business-type"></span></p>
        </div>
    </div>
</div>

<div id="topbar"> </div> 
    
<div id="header-inner"> 
	<?php include('topbar.php'); ?>  
</div> <!--header-inner-->

<div id="post_topbar"> 
	<table>
		<tr>
           	<td><a href="dashboard.php"><div> Home </div></a></td>
            <td><a href="myprofile.php"><div> My Profile </div></a></td>
            <td><a href="postjob.php"><div> Post A Job </div></a></td>
            <td class="selected"><a href="vcon.php"><div> View Contractors </div></a></td>
            <td><a href="refer.php"><div> Refer A Friend </div></a></td>
            <td id="topbar_tdfix"><a href="support.php"><div> Support </div></a></td>
        </tr>
    </table>
</div>


<div id="content">
	<div id="content-inner"></div><!--content-inner-->
    <div id="vc-wrap">
   	<div id="vc-content">
    	<div id="vc-search"> 
        	<div id="search-title" style="padding-left: 10px;">Name, email, phone, address, state, business type:</div>
            <div id="search-main">
            	<table id="search-table">
                	<tr>
                    	<td id="td-search"> Search: </td>
                        <td> </td>
                    	<td> </td>
                        <td class="td-inform"><input form="text" id="input-search" /> </td>
                        <td id="td-sbutton"><button style="border:none" id="s-button" type="button" onclick="loadXMLDoc()">Search</button></td>
               </table>
           </div> <!--search-main-->
           
        </div> <!--vc-search-->
		
        <div id="vc-contracts">
       
             
        </div> <!--vc-contracts-->
       
        <div id="vc-main">
        	<table>            
            	<th><div id="vc-mtitle"> My Contractors </div></th>
                 <?			
					$select = "SELECT id,fid FROM frndrequest WHERE uid=".$uid." ";
					$rez = mysql_query($select);
					while($data = mysql_fetch_array($rez)){
						$select2 = "SELECT id FROM frndrequest WHERE uid=".$data['fid']." AND fid=".$uid." ";
						$rez2 = mysql_query($select2);
						$data2 = mysql_fetch_object($rez2);
						if(is_object($data2)) $friends = "";
						else $friends = "<div class=\"vc-txtmid\"> Awaiting approval </div>";
						//if(!is_object($data2)) print "Awaiting approval";	

						//if(is_object($data2)){
						$select_friend = "SELECT id, name, address, state, email, phone, business_type FROM users WHERE id=".$data['fid']." ";
						$friend_query = mysql_query($select_friend);
						$friend_data = mysql_fetch_object($friend_query);
						if(is_object($friend_data)){															
							$expertise = "";
							
							$select_picture = "SELECT filename FROM users_pic WHERE user_id=".$data['fid']." ";
							$picture_query = mysql_query($select_picture);
							$picture_data = mysql_fetch_object($picture_query);
							if(is_object($picture_data)){
								$picture = SCONFIG::UPLOAD_DIR.$picture_data->filename;
							}else{
								$picture = STEMPLATE::FACEBOX_DEFAULT_IMAGE;
							}
							
							$cuid = $data['fid'];
							
							print "<tr>
									<td class=\"curved\">
										<div class=\"vc-body\">
											<div class=\"body-l\">
												<span class=\"vc-del-contractor\" onclick=\"delete_contractor('".$uid."', '".$cuid."')\"><b>x</b></span>
												<div class=\"vc-imgup\"><img src=\"".$picture."\" onclick=\"showBias('".$friend_data->name."', '".$picture."', '".$friend_data->address."', '".$friend_data->state."', '".$friend_data->email."', '".$friend_data->phone."', '".$friend_data->business_type."')\" height=\"100%\" width=\"100%\"> </div>
												<div class=\"vc-txtmid\"> ".$friend_data->name." </div>".$friends."
												<div class=\"vc-txtd\"> ".$expertise." </div>
											</div> <!--body-l-->
											<div class=\"body-r\">
												<a href=\"javascript:void(0)\"><div id=\"ml".$cuid."\" class=\"body-imgr\"  onclick=\"compose(".$cuid.");\" > Contact this User </div></a>";
												
							?>
								
                                <div id="mydiv<?php echo $cuid; ?>" style="display:none; background:url(images/compose_bg.png);">
                    			<div class="mail_compose">
                    			<div style="height: 30px; line-height: 24px; text-align: right; width: 98%;"><a style="cursor:pointer; color:#FFF;" onclick="closebox(<?php echo $cuid; ?>);">X</a></div>
                    			<div style="width:100%; height:100%; color:#000; padding-left:26px; padding-top:23px">
                    			<form name="compose_msg">
                    <table style="width:486px; text-align:left; border:none; border-collapse:collapse;" class="vcon-msg">
                    <tr>
                    <td valign="top" width="85" style="padding-right:0; text-align:left; border:none; color:black; padding-left:0; padding-bottom:2px;">Subject : </td><td style="text-align:left; border:none; padding-bottom:2px;" ><input id="subject<?php echo $cuid; ?>" style="width:395px; height:30px;" type="text" name="subject<?php echo $cuid; ?>" /></td>
                    </tr>
                    <tr>
                    <td width="85" style="padding-right:0; text-align:left; border:none; color:black; padding-left:0;padding-bottom:2px;" valign="top" >Message : </td><td style="text-align:left; border:none; padding-bottom:2px;"><textarea id="message<?php echo $cuid; ?>" style="width:395px; height:80px;" name="message<?php echo $cuid; ?>"></textarea></td>
                    </tr>
                    <tr>
                    <td style="text-align:left; border:none; padding-bottom:2px;"></td><td style="border:none;padding-bottom:2px; " align="right"><button type="button" class="compose_send_btn" onclick="sendmsg(<?php echo $cuid; ?>);"></button><button type="button" onclick="closebox(<?php echo $cuid; ?>);" class="compose_cancel_btn"></button>
                    </td>
                    </tr>
                    </table>
                    </form>
                    </div>
                    </div>
                    <a style="color:black" onclick="closebox(<?php echo $cuid; ?>);">close</a>
                    </div>
                                			
							<?php				
												
							print			"</div> <!--body-r-->
										</div> <!--vc-body-->
									</td>
								</tr>
								<tr class=\"spacer\"><td></td></tr>";
						}
						//}
						
					}
					//die();
				?>                                           
            </table>
            
            
        
        </div><!--vc-main-->
        
    </div> <!--vc-content-->  
    </div> <!--vc-wrap-->
</div><!--content-->
<?php
include('footer.php');
?>
</body>
</html>
