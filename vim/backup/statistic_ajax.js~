$(document).ready(function() {
	$("#export-csv").click(function() {
		$.ajax({
			url: "php/download_statistic.php",
			dataType: "json",
			success: function(data) {
				alert(data.url);
				window.open(data.url);
				// $.ajax({
				// 	url: "php/delete_statistic.php"
				// });
			}
		});
	});

	var input_ans;
	$('#browseq-button').click(function() {
		if (!isInputOk(".loading-cloud-small"))
			return false;

		var qid = $("#qid").val();
		var zip = $("#zip").val();
		var answers = $("#answers").val();
		var category = $("#category").val();
		input_ans = $("#answer-type-checkbox").is(":checked");

		if (answers != "" && !input_ans && !is_string_valid(answers, "123456789, ")) {
			alert("Answer selector '"+answers+"' is not valid. Numbers separated with comas are allowed only. Check the checkbox if you want to treat this as an actual answer");
			return false;
		}

		var data = "qid="+qid+"&category="+category;
		if (zip != "")		data += "&zip="+zip;
		if (answers != "")	data += "&answers="+answers;
		if (input_ans)		data += "&input=1";

		$.ajax({
			url: "php/get_ans_statistic.php",
			type: "POST",
			data: data,
			dataType: "json",
			success: function(data) {
				if (!input_ans)
					show_statistic(data);
				show_emails(data);

			},
			error: function(jqXHR, status_str, error) {
				alert(jqXHR + " || " + status_str + " || " + error);
			}
		});
	});

	function show_statistic(data_json)
	{
		var max_height = parseInt($("#gb-1").css("max-height"));
		for (i = 0; i <= 7; ++i) {
			var height = max_height / 100 * data_json.statistic["answer"+i];
			$("#gb-"+(i+1)).css("height", height+"px");
		}
	}

	function show_emails(data_json)
	{
		var total = data_json.statistic["total"];
		$("#total-people").html(total);
		for (var i = 0; i < 9; ++i)
			$(".email-"+i).html("");
		for (var i = 0; i < Math.min(total, 9); ++i)
			$(".email-"+i).html(data_json.users[i].user);
	}
});
