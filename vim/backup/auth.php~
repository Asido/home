<?php

require_once('database.php');
require_once('config.php');
require_once('mail.php');

$auth = new auth();

class auth
{
	var $db;

	public function auth()
	{
		$this->db = database::get_instance();
	}


	public function signup($email, $zip, $password, $cid, $guest_key)
	{
		$db = $this->db;
		// remove sql injections if any
		$db->format_string($email);
		$db->format_string($zip);
		$db->format_string($password);
		
		$query = "INSERT INTO `users`(`username`, `password`, `zip`, `active`, `cid`) VALUES
			('".$email."', SHA1('".$password."'), '".$zip."', 0, '".$cid."')";
		$ok = $db->query($query);
		if ($ok)
			Mail::send_welcome_mail($email, $zip, $password, $cid, $guest_key);
		return $ok;
	}

	public function login($username, $password, $remember = true, $encrypt_password = true)
	{
		$db = database::get_instance();

		$db->format_string($username);
		$db->format_string($password);

		if (!$username || !$password) {
			echo "Bad input provided";
			exit;
		}

		if ($encrypt_password)
			$password = sha1($password);

		if (!$db) {
			echo "Connection to the database failed";
			exit;
		}
		$query = "SELECT *
				  FROM users
				  WHERE username = '".$username."'
				  AND password = '".$password."'
				  AND active = 1";
		$result = $db->query($query);
		if (mysql_num_rows($result) == 0) {
			$this->logout();
			return false;
		}

		$db->query('UPDATE `users` SET `last_login` = CURDATE() WHERE `username` = \''.$username.'\'');

		if (!isset($_SESSION))
			session_start();
		$_SESSION['username'] = $username;

		if ($remember) {
			$expire_time = time() + CONFIG::COOKIE_EXPIRE_TIME;
			setcookie('username', $username, $expire_time);
			setcookie('password', sha1($password), $expire_time);
			setcookie('expire_time', $expire_time, $expire_time);
		} else {
			setcookie('username', false);
			setcookie('password', false);
			setcookie('expire_time', false);
		}

		return true;
	}

	public function cookie_login()
	{
		if (!(isset($_COOKIE['username']) || isset($_COOKIE['password']) || isset($_COOKIE['expire_time'])))
			return false;

		$db = $this->db;
		$_COOKIE['username'] = $db->format_string($_COOKIE['username']);
		$_COOKIE['password'] = $db->format_string($_COOKIE['password']);
		$_COOKIE['expire_time'] = $db->format_string($_COOKIE['expire_time']);

		if ($this->logged_in() !== false) {
			if (isset($_COOKIE['username']))
				$db->query('UPDATE `users` SET `last_login` = CURDATE() WHERE `username` = \''.$_COOKIE['username'].'\'');
			return true;
		}

		$time = time();
		if ($_COOKIE['expire_time'] < $time) {
			unset($_COOKIE);
			return false;
		}
		return $this->login($_COOKIE['username'], $_COOKIE['password'], true, false);
		$this->
	}

	public function logged_in()
	{
		if (!isset($_SESSION))
			session_start();

		if (!isset($_SESSION['username']))
			return false;
		return true;
	}

	public function logout()
	{
		if (!isset($_SESSION))
			session_start();
		session_destroy();
		setcookie('username', false);
		setcookie('password', false);
		setcookie('expire_time', false);
	}

	public function confirm_account($cid)
	{

	}

	public function remind_password($email)
	{
		$db = $this->db;
		$db->format_string($email);
		$password = $this->generate_password();
		$db = $this->db;
		$query = "UPDATE users
			 	  SET password = '".sha1($password)."'
				  WHERE username = '".$email."'";
		$changed = $db->query($query);

	//	if ($changed == 1)
			Mail::send_password_reminder_mail($email, $password);	
		return $changed;
	}
	
	public function set_first_name($name, $email = "")
	{
		$db = $this->db;
		$name = $db->format_string($name);
		$email = $db->format_string($email);
		if ($email == "")
			$email = $_SESSION['username'];
		$query = "UPDATE `users` SET `first_name`='".$name."' WHERE `username`='".$email."'";
		return $db->query($query);
	}
	
	public function set_last_name($name, $email = "")
	{
		$db = $this->db;
		$name = $db->format_string($name);
		$email = $db->format_string($email);
		if ($email == "")
			$email = $_SESSION['username'];
		$query = "UPDATE `users` SET `last_name`='".$name."' WHERE `username`='".$email."'";
		return $db->query($query);
	}

	public function change_password($old_psw, $new_psw)
	{
		$db = $this->db;
		$query = "SELECT `password` FROM `users` WHERE `username`='".$_SESSION['username']."'";
		$sql = $db->query($query);
		$result = mysql_fetch_array($sql);
		if ($result['password'] != sha1($old_psw))
			return false;
		$query = "UPDATE `users`
				  SET `password` = '".sha1($new_psw)."'
				  WHERE `password` = '".sha1($old_psw)."'
				  AND `username` = '".$_SESSION['username']."'";
		return $db->query($query);
	}

	private function generate_password($length = 8)
	{
		$password = "";
		$possible = "2346789bcdfghjkmnpqrtvwxyzBCDFGHJKLMNPQRTVWXYZ";
		$maxlength = strlen($possible);
		if ($length > $maxlength)
			$length = $maxlength;
		$i = 0;
		while ($i < $length) {
			$char = substr($possible, mt_rand(0, $maxlength-1), 1);
			if (!strstr($password, $char)) {
				$password .= $char;
				$i++;
			}
		}
		return $password;
	}

	public function get_points($username)
	{
		$query = "SELECT `points`
				  FROM `users`
				  WHERE `username` = '".$username."'";
		$db = $this->db;
		$result = $db->query($query);
		return mysql_fetch_object($result)->points;
	}

	public function get_avatar()
	{
		$db = $this->db;
		$query = "SELECT `avatar_filename` FROM `users` WHERE `username`='".$_SESSION['username']."'";
		$sql = $db->query($query);
		$result = mysql_fetch_array($sql);
		return $result['avatar_filename'];
	}

	public function get_groups($username)
	{
		$db = $this->db;
		$db->format_string($username);
		$query = "SELECT * FROM `groups` WHERE `id` IN
						(SELECT `group_id` FROM `groups_MTM_users` WHERE `username`='".$username."')";
		$sql = $db->query($query);
		return $db->to_array($sql);
	}

	public function get_group_member_count($group)
	{
		$db = $this->db;
		$query = "SELECT COUNT(*) FROM `groups_MTM_users` WHERE `group_id`='".$group."'";
		$sql = $db->query($query);
		$sql = mysql_fetch_array($sql);
		return $sql[0];
	}

	public function get_group_question_count($group)
	{
		$db = $this->db;
		$query = "SELECT COUNT(*) FROM `group_questions` WHERE `group_id`='".$group."'";
		$sql = $db->query($query);
		$sql = mysql_fetch_array($sql);
		return $sql[0];
	}

	public function join_group($group_id, $username)
	{
		$db = $this->db;
		$db->format_string($group_id);
		$db->format_string($username);

		$query = "SELECT * FROM `groups_MTM_users` WHERE `group_id`=".$group_id." AND `username`='".$username."'";
		$sql = $db->query($query);
		if (mysql_num_rows($sql) != 0)
			return;

		$query = "INSERT INTO `groups_MTM_users` (`group_id`,`username`) VALUES (".$group_id.", '".$username."')";
		$db->query($query);
	}

	public function questions_created($username)
	{
		$db = $this->db;
		$db->format_string($username);

		$questions_created = $db->get_field_value("users", "questions_asked", "`username`='".$_SESSION['username']."'");
		
		return $questions_created;
	}

}

?>
