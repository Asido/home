<?php

/**
 * used by popup.js to retrieve statistics for answered questions to put in profques.php popup
 */

require_once('database.php');

$db = database::get_instance();

$category = $_POST['category'];
$qid = $_POST['qid'];

// get question and answer choices
$query = "SELECT * FROM `".$category."_questions` WHERE `id` = ".$qid;
$result = $db->query($query);
$question = mysql_fetch_array($result);

// get all answers with the ID retrieved above
$query = "SELECT `answer` FROM `".$category."_answers` WHERE `question_id` = ".$qid;
$result = $db->query($query);
// total amount of answers
$answer_count = mysql_num_rows($result);

// initial values for answer occurances
$answer1_count = 0;
$answer2_count = 0;
$answer3_count = 0;
$answer4_count = 0;

// loop to get the count of each answer
while ($row = mysql_fetch_row($result)) {
	switch ($row[0]) {
		case 1:
			$answer1_count++;
			break;
		case 2:
			$answer2_count++;
			break;
		case 3:
			$answer3_count++;
			break;
		case 4:
			$answer4_count++;
			break;
		default:
			break;
	}
}

// calculates each answer count in percent
$init_percent = ($answer_count > 0 ? 100 / $answer_count : 0);
$answer1_percent = number_format($init_percent * $answer1_count, 2);
$answer2_percent = number_format($init_percent * $answer2_count, 2);
$answer3_percent = number_format($init_percent * $answer3_count, 2);
$answer4_percent = number_format($init_percent * $answer4_count, 2);

// and finally return the result as JSON
echo "{ \"question\"		: \"".$question['question']."\",
		\"answer_count\"	: \"".$question['answer_count']."\",
		\"answer1\"			: \"".$question['answer1']."\",
		\"answer2\"			: \"".$question['answer2']."\",
		\"answer3\"			: \"".$question['answer3']."\",
		\"answer4\"			: \"".$question['answer4']."\",
		\"answer5\"			: \"".$question['answer5']."\",
		\"answer6\"			: \"".$question['answer6']."\",
		\"answer7\"			: \"".$question['answer7']."\",
		\"answer8\"			: \"".$question['answer8']."\",
		\"answer1_percent\" : \"".$answer1_percent."\",
		\"answer2_percent\" : \"".$answer2_percent."\",
		\"answer3_percent\" : \"".$answer3_percent."\",
		\"answer4_percent\" : \"".$answer4_percent."\" }";

exit;

?>
