<?php

require_once('php/database.php');
require_once('php/auth.php');
require_once('php/guests.php');

$ok = false;
$db = database::get_instance();

$db->format_string($_GET['cid']);
$db->format_string($_GET['gid']);
$cid = $_GET['cid'];
$gid = $_GET['gid']

$guest = new guest( $gid );

if (	isset($cid) && !empty($cid) /*	&& ( $guest->rem_answers() <= $guest->questions_num() * 0.5 ) */	) {

	$query = "SELECT *
			  FROM users
			  where cid = '".$cid."'";
	
	$result = $db->query($query);
	if (mysql_num_rows($result) > 0) {
		$query = "UPDATE users
				  SET active = '1'
				  WHERE cid = '".$cid."'";
		$ok = $db->query($query);
		
		if ( $ok )
		{	
			$user_info	= $db->fetch( $result );
			if ($user_info['active'] == 0)
			{
				$answers 	= $guest->get_answers();
			
				foreach ($answers as $answer)
				{
					$db->query(
							'	INSERT
								INTO `users_profile_answers`
								VALUES (
									'	.$answer['question_id'].	',
									\''	.$user_info['username'].	'\',
									'	.$answer['answer'].			' )	' );
				}	
			
			//$guest->delete_guest();
			}
		}
	}
}



$logged = $auth->logged_in();

?>


<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<link rel="stylesheet" href="css/styles.css" />
<script type="text/javascript" src="js/jquery-1.4.2.js"></script>
<script type="text/javascript" src="js/login.js"></script>
<script type="text/javascript" src="js/submit.js"></script>
<script type="text/javascript" src="js/validation.js"></script>
<script type="text/javascript" src="js/notif.js"></script>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
<title>LikeMeLikeYou</title>
</head>

<body>

<?php
	include_once('php/html.php');

	if ($logged)
		HTML::show_logged_header();
	else
		HTML::show_header("signup.php");
?>
<div id="center-top" class="div-center">
	<p id="lb-ltitle">
	<?php
	if ($ok)
		echo CONFIG::EMAIL_CONFIRM_SUCCESS;
	else
		echo CONFIG::EMAIL_CONFIRM_FAIL;
	?>
	</p>
</div>
<?php

HTML::show_background();
HTML::show_footer();
?>

</body>
</html>
