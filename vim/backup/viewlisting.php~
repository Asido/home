<?php
/**
 * @copyright 68 Classifieds
 *
 * @author 68 Designs, LLC
 * @version $Revision: 253 $
 * @package 68Classifieds
 * @link http://www.68classifieds.com
 *
 * @Updated: $Date: 2009-03-01 15:29:14 -0500 (Sun, 01 Mar 2009) $
 */
require_once ('includes/init.php');
$Listing = Library::loadLibrary('Listings');
$view = (empty($_GET['view'])) ? 1 : (int) $_GET['view'];

if (isset($_SESSION['uid']))
{
	$userid = (int) $_SESSION['uid'];
	$class_tpl->assign('isFavorite', $Listing->isFavorite($view, $userid));
}
$class_tpl->assign('canSaveFavorites', $canSaveFavorites);
$class_tpl->assign('viewphotos', $canViewPhotos);
$class_tpl->assign('viewseller', $canViewSeller);
$class_tpl->assign('viewaddress', $canViewAddress);
$class_tpl->assign('viewcity', $canViewCity);
$class_tpl->assign('viewstate', $canViewState);
$class_tpl->assign('viewcountry', $canViewCountry);
$class_tpl->assign('viewprice', $canViewPrice);
$class_tpl->assign('viewdate', $canViewDateAdded);
$class_tpl->assign('viewexpiration', $canViewExpiration);
$class_tpl->assign('viewhits', $canViewHits);
$class_tpl->assign('viewphone', $canViewPhone);
$class_tpl->assign('cols', $rs['lCols']);

$class_tpl->assign('allowcontact', $canContact);
$class_tpl->assign('allowfriendmail', $canEmailFriend);
$result->freeResult($result);

if (!$class_tpl->is_cached('layout.tpl', 'listing|' . $view . '|' . $userid))
{
	require_once (FILESYSTEM_PATH . 'includes/classes/kernel/Categories.php');
	require_once (FILESYSTEM_PATH . 'includes/classes/kernel/Users.php');
	
	$Categories = new Categories();
	$Users = new Users();
	
	$go = TRUE;
	if (!empty($_GET['view']))
	{
		$view = (int) $_GET['view'];
		if (!$Listing->getListingById($view))
		{
			$go = FALSE;
		}
		else
		{
			$rs = $Listing->getListingById($view);
		}
	}
	else
	{
		$go = FALSE;
	}
	if ($go == FALSE)
	{
		//no rows where found. Must be either expired or deleted. Lets show the not available page
		//header("Location: search.php");
		$view = 0;
		$class_tpl->assign('available', FALSE);
		$class_tpl->assign('body', 'viewlisting/notavailable.tpl');
	}
	else
	{
		$listing_rs = $rs;
		$title .= ' ' . LANG_CAT_SEPERATOR . ' ' . $rs['title']; //escaped in Listings
		$class_tpl->assign('sitetitle', $title);
		$desc = str_replace("\r\n", ", ", $rs['description']); //sanitized HTML
		$class_tpl->assign('sitedescription', dot(strip_tags($desc), 50));
		$Listing->updateHitCount($view);
		$class_tpl->assign('view', $view);
		$class_tpl->assign('extrafields', $Listing->getListingFields($view));
		$class_tpl->assign('breadcrumb', $Categories->breadcrumb($rs['section'], 0));
		$user = $Users->getUser($rs['owner']);
		$modules->call_hook('view_listing', $view); // Call any module functions
		

		//get the display fields
		$sSQL = "SELECT lDisplay,lCols FROM " . PREFIX . "listing_settings WHERE lID=1";
		$result = $db->query($sSQL);
		$rs = $result->fetch();
		$lDisplay = $rs['lDisplay'];
		$class_tpl->assign('cols', $rs['lCols']);
		//header
		$head = '<script type="text/javascript" src="javascript/jquery/thickbox/thickbox-compressed.js"></script>
			<link rel="stylesheet" href="javascript/jquery/thickbox/thickbox.css" type="text/css" media="screen" />';
		
		$class_tpl->assign('header', $head);
		//goto
		$goto = ltrim(strrchr($_SERVER['REQUEST_URI'], '/'), '/');
		$goto = str_replace('...', '', $goto);
		$goto = urlencode($goto);
		$class_tpl->assign('goto', $goto);
		
		if ($lDisplay == 1)
		{
			$class_tpl->assign('body', 'viewlisting.tpl');
		}
		else
		{
			$class_tpl->assign('body', 'viewlisting2.tpl');
		}
		$modules->call_hook('viewlisting_end', $listing_rs); // Call any module functions
	}
}
//now display the template
$class_tpl->display('layout.tpl', 'listing|' . $view . '|' . $userid);
$db->disconnect();

/* End of file viewlisting.php */
/* Location: ./upload/viewlisting.php */
