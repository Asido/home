<?php

$rand=$class->createRandomPassword();

if(isset($_POST['SubmitCategory']))

{

	if($_FILES['txtimport']['name'] != "") 

	{

	$selectf=$class->F($class->query(TB_IMPORT));

	$filenamee="csv/".$selectf['importfile'];

	unlink($filenamee);

	$sourcename1 = "csv_".$rand."_".$_FILES['txtimport']['name'];

	move_uploaded_file($_FILES['txtimport']['tmp_name'], "csv/".$sourcename1);

	}

	$check=$class->C($class->query(TB_IMPORT));

	if($check>0)

	{

		if($sourcename1!=""){$str=$class->Q("UPDATE ".TB_IMPORT." SET importfile='".$sourcename1."'");}	

	}

	else

	{

		$str=$class->Q("INSERT INTO ".TB_IMPORT." SET importfile='".$sourcename1."'");

	}

	if($str)

	{

		$select=$class->F($class->query(TB_IMPORT));

		$filename="csv/".$select['importfile'];

		$handle = fopen("$filename", "r");

		$i=0;
		
		while (($data = fgetcsv($handle, 3000, ",")) !== FALSE)

		{
			
		if ($data[$i] == "") {$data[$i]=" ";}
		
		//$data[$i] = htmlspecialchars(addslashes($data[$i]));

		$posst=explode("/",$data[37]);

		$newpost=$posst[2]."-".$posst[0]."-".$posst[1];

		$lasst=explode("/",$data[38]);

		$lasstpost=$lasst[2]."-".$lasst[0]."-".$lasst[1];

		

		

		$check=$class->C($class->where(TB_PRODUCT,"id",$data[0]));

		if($check>0)

		{
	    // update
		// grouped these in a better way for easier reading and of course for the db inclusion- Will

		$import="UPDATE ".TB_PRODUCT." SET "; 
		
		$import.="categoryid='$data[1]',subcategoryid='$data[2]',productname='$data[3]',title1='$data[4]',title2='$data[5]',";

		$import.="cost='$data[6]',listprice='$data[7]',listprice_status='$data[8]',dealercost='$data[9]',";

		$import.="quantity='$data[10]',qty_status='$data[11]',availability='$data[14]',";
		
		$import.="description='".addslashes($data[12])."',featured_text='".addslashes($data[13])."',";

		$import.="image1='$data[15]',image2='$data[16]',image3='$data[17]',";		
		
        $import.="small1='$data[18]',small2='$data[19]',small3='$data[20]',";
		
		$import.="big1='$data[21]',big2='$data[22]',big3='$data[23]',";
		
		$import.="feature_img='$data[24]',";
		
		$import.="option1='$data[25]',option2='$data[26]',option3='$data[27]',";

		$import.="audioclip='$data[28]',audiosound2='$data[29]',";

		$import.="usa_standard='$data[30]',usa_priority='$data[31]',usa_express='$data[32]',int_standard='$data[33]',int_priority='$data[34]',int_express='$data[35]',";

		$import.="reference='$data[36]',postdate='$newpost',lastupdate='$lasstpost',display='$data[39]',";

		$import.="feature='$data[40]',recent_added='$data[41]',status='$data[42]',feature_display='$data[43]',recent_display='$data[44]',make_offer='$data[45]' ";
		
		$import.="where id='$data[0]'";

		}

		else
		
		// insert

		{

         if($data[1] != "categoryid")

		{

		 
		$import="INSERT INTO ".TB_PRODUCT."(categoryid,subcategoryid,productname,title1,title2,cost,listprice,listprice_status,";

		$import.="dealercost,quantity,qty_status,description,featured_text,";

		$import.="availability,image1,image2,image3,small1,small2,small3,big1,big2,big3,feature_img,option1,option2,";

		$import.="option3,audioclip,audiosound2,usa_standard,usa_priority,usa_express,int_standard,int_priority,";

		$import.="int_express,reference,postdate,lastupdate,display,feature,recent_added,status,feature_display,recent_display,make_offer)values";

		$import.="('$data[1]','$data[2]','$data[3]','$data[4]',";

		$import.="'$data[5]','$data[6]','$data[7]','$data[8]','$data[9]','$data[10]','$data[11]','$data[12]','$data[13]',";

		$import.="'$data[14]','$data[15]','$data[16]','$data[17]','$data[18]','$data[19]','$data[20]','$data[21]','$data[22]','$data[23]',";

		$import.="'$data[24]','$data[25]','$data[26]','$data[27]','$data[28]','$data[29]','$data[30]','$data[37]','$data[38]','$data[33]',";

		$import.="'$data[34]','$data[35]','$data[36]','$newpost','$lasstpost','$data[39]')";
		
		$import.="'$data[40]','$data[41]','$data[42]','$data[43]','$data[44]','$data[45]')";

		}
		}
		

		if($data[0]!="" && $i!="0" && is_numeric($data[0]) && $data[1] != "categoryid")

		{

		echo $import."<br><br><br>";

		mysql_query($import) or die(mysql_error());
		}

		$i++;

		}

		fclose($handle);

		echo $class->R("home.php?action=import&succ");

	}



}

?>

<span class="procedures">

              <ul><span class="title">Import Products</span>

                <form name="form1" action="" method="post" enctype="multipart/form-data">

					<table width="100%" border="0" align="center" cellpadding="0" cellspacing="0" class="bordersytle">

                    <tr>

                      <td width="37%" height="25" align="left" valign="middle">&nbsp;

                      </td>

                      <td width="63%" align="left" valign="middle">&nbsp;

                      <?php

                      if(isset($_GET['succ'])){echo "<span class='green'>Successfully File Imported</span>";}

					  if(isset($_GET['err'])){echo "<span class='red'>Error, please try again</span>";}

					  ?>

                      </td>

                      </tr>

                    <tr>

                      <td align="center" valign="middle" class="black12"> Select File</td>

                      <td align="left" valign="middle" class="black12">

                      <input type="file" name="txtimport" id="txtimport"/></td>

                    </tr>

                    <tr>

                      <td align="left" valign="middle" class="black12">&nbsp;</td>

                      <td align="left" valign="middle" class="red">&nbsp;<span id="r1"></span></td>

                    </tr>

                    <tr>

                      <td height="40" align="left" valign="middle">&nbsp;</td>

                      <td align="left" valign="middle">

                      <input type="submit" name="SubmitCategory" class="buttonbg" value="Import" /></td>

                    </tr>

                    <tr>

                      <td align="left" valign="middle"><?php if(isset($_GET['removed'])){echo "<span class='green'>Successfully Category Removed</span>";}?></td>

                      <td align="left" valign="middle">&nbsp;</td>

                    </tr>

                  </table>

                  </form>

              </ul>

             </span>          
